<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>(ì£¼)ì˜ì„ ê¸°ê³„ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ V6.9.2 (Bucket Pro)</title>
  
  <meta name="theme-color" content="#1e1e1e">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2920/2920323.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    :root {
      --bg-color: #121212; 
      --sidebar-bg: #1e1e1e; 
      --card-bg: #252525; 
      --border-color: #333;
      --primary-color: #4A90E2;
      --primary-hover: #357ABD;
      --text-color: #e0e0e0;
      --text-muted: #a0a0a0;
      --danger-color: #cf6679;
      --accent-color: #03dac6;
      --success-color: #00e676;
      --warning-color: #ff9f43;
      --sidebar-width: 240px;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
      margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex;
    }

    .app-container { display: flex; width: 100%; height: 100%; }

    /* ì‚¬ì´ë“œë°” */
    .sidebar {
      width: var(--sidebar-width); background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color); display: flex; flex-direction: column;
      flex-shrink: 0; transition: transform 0.3s ease; z-index: 1000;
    }
    .sidebar-header {
      padding: 20px; border-bottom: 1px solid var(--border-color);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .sidebar-header h2 { font-size: 1.2rem; margin: 0; color: #fff; text-align: center; }
    .sidebar-header .sub-text { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; }

    .nav-group-label { padding: 15px 20px 5px 20px; font-size: 0.75rem; color: #666; font-weight: bold; text-transform: uppercase; }
    .nav-menu { flex: 1; padding: 10px 0; overflow-y: auto; }
    .nav-item {
      display: flex; align-items: center; padding: 12px 20px; color: var(--text-muted);
      text-decoration: none; cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; font-weight: 500;
    }
    .nav-item:hover { background-color: rgba(255,255,255,0.05); color: #fff; }
    .nav-item.active { background-color: rgba(74, 144, 226, 0.15); color: var(--primary-color); border-left-color: var(--primary-color); }
    .nav-icon { margin-right: 10px; width: 20px; text-align: center; }
    .sidebar-footer { padding: 15px; border-top: 1px solid var(--border-color); font-size: 0.8rem; text-align: center; color: #666; }

    /* ë©”ì¸ ì˜ì—­ */
    .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
    .top-bar {
      height: 60px; background-color: var(--sidebar-bg); border-bottom: 1px solid var(--border-color);
      display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0;
    }
    .hamburger-btn { display: none; background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }
    .content-area { flex: 1; padding: 20px; overflow-y: auto; }

    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* UI ì»´í¬ë„ŒíŠ¸ */
    .card {
      background: var(--card-bg); border-radius: 12px; padding: 20px;
      margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #333;
    }
    h3 { margin-top: 0; color: #fff; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
    
    input[type="text"], input[type="date"], select, textarea {
      background: #333; border: 1px solid #555; color: #fff;
      padding: 8px 12px; margin: 4px; border-radius: 4px; font-size: 14px;
    }
    textarea { resize: vertical; line-height: 1.5; font-family: inherit; }
    input:focus, select:focus, textarea:focus { outline: 2px solid var(--primary-color); border-color: transparent; }

    button {
      background: #444; color: #fff; border: 1px solid #555;
      padding: 8px 16px; cursor: pointer; border-radius: 4px; transition: background 0.2s;
    }
    button:hover { background: #555; }
    .btn-primary { background: var(--primary-color); border-color: var(--primary-color); }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-danger { background: var(--danger-color); border-color: var(--danger-color); color: #000; }
    .btn-accent { background: var(--accent-color); border-color: var(--accent-color); color: #000; font-weight:bold; }
    
    /* ì„ ì‘ì—… ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn-prework { background: #444; color: #fff; border: 1px solid #555; } 
    .btn-prework.registered { background: var(--accent-color); color: #000; font-weight: bold; border-color: var(--accent-color); } 
    
    .table-container { overflow-x: auto; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    th { background: #2a2a2a; color: var(--text-muted); font-weight: 600; white-space: nowrap; }
    tr:hover { background: #2f2f2f; }

    /* [NEW] ë²„ì¼“ì£¼ê¸° ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
    .bk-filter-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
    .bk-filter-btn { 
        white-space: nowrap; padding: 8px 16px; border-radius: 20px; 
        background: #333; border: 1px solid #555; color: #aaa; cursor: pointer; 
    }
    .bk-filter-btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); font-weight: bold; }
    
    .bk-dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
    .bk-card { 
        background: #2f2f2f; border: 1px solid #444; border-radius: 12px; padding: 20px; 
        display: flex; flex-direction: column; transition: transform 0.2s; position: relative;
    }
    .bk-card:hover { transform: translateY(-3px); border-color: var(--primary-color); }
    .bk-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom:10px; border-bottom:1px solid #444; }
    .bk-dept { font-size: 1.1em; font-weight: bold; color: #fff; }
    .bk-latest-date { font-size: 0.9em; color: #aaa; }
    .bk-elapsed-box { 
        background: #222; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; 
        border: 1px solid #333;
    }
    .bk-elapsed-label { font-size: 0.8em; color: #888; margin-bottom: 5px; }
    .bk-elapsed-val { font-size: 1.8em; font-weight: bold; color: var(--success-color); }
    .bk-elapsed-val.warn { color: var(--warning-color); }
    .bk-elapsed-val.danger { color: var(--danger-color); }
    
    .bk-history-toggle { 
        text-align: center; color: var(--primary-color); cursor: pointer; font-size: 0.9em; 
        padding-top: 10px; border-top: 1px dashed #444; user-select: none;
    }
    .bk-history-list { display: none; margin-top: 10px; background: #252525; padding: 10px; border-radius: 6px; }
    .bk-history-item { 
        display: flex; justify-content: space-between; font-size: 0.85em; 
        padding: 6px 0; border-bottom: 1px solid #333; color: #ccc; align-items:center;
    }
    .bk-history-item:last-child { border-bottom: none; }

    .status-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; color: #aaa; text-align: center; min-width: 50px; cursor: pointer; margin: 2px; background-color: #333; border: 1px solid #555; transition: all 0.1s; user-select: none; }
    .status-badge.active-1 { background-color: var(--success-color) !important; color: #000 !important; } 
    .status-badge.active-2 { background-color: var(--primary-color) !important; color: #fff !important; } 
    .status-badge.active-3 { background-color: var(--warning-color) !important; color: #000 !important; } 
    .status-badge.active-4 { background-color: #9C27B0 !important; color: #fff !important; } 
    .status-badge.permit-active { background-color: var(--primary-color) !important; color: #fff !important; } 
    .status-badge.done-active { background-color: var(--success-color) !important; color: #000 !important; } 
    .status-badge.order-active { background-color: var(--warning-color) !important; color: #000 !important; } 
    .status-badge.stock-active { background-color: var(--success-color) !important; color: #000 !important; } 

    .flex-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
    .paginator { margin-top: 15px; display: flex; justify-content: center; gap: 4px; }
    .paginator button.active { background: var(--primary-color); border-color: var(--primary-color); }
    .link-text { color: var(--accent-color); text-decoration: underline; cursor: pointer; }
    .text-red { color: #ff6b6b; font-weight: bold; }

    /* ëª¨ë‹¬ */
    .modal {
      display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7); backdrop-filter: blur(3px);
      align-items: center; justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background-color: var(--card-bg); padding: 25px; border-radius: 12px;
      width: 90%; max-width: 800px; max-height: 90vh;
      border: 1px solid #444; display: flex; flex-direction: column; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
    .modal-footer { margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 10px; }
    .close-modal { font-size: 24px; cursor: pointer; color: #aaa; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
    .form-group { display: flex; flex-direction: column; }
    .checkbox-group { display: flex; gap: 15px; background: #333; padding: 10px; border-radius: 4px; }
    .checkbox-group label { display: flex; align-items: center; cursor: pointer; color: #fff; margin:0; }
    .checkbox-group input { width: 18px; height: 18px; margin-right: 8px; accent-color: var(--primary-color); }

    /* ë‹¬ë ¥ & ë°œì£¼ & ì ê²€ì¼ì§€ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .split-view-container { display: flex; flex-wrap: wrap; gap: 20px; }
    .calendar-panel { flex: 1; min-width: 350px; background: #252525; padding: 15px; border-radius: 12px; border: 1px solid var(--border-color); }
    .detail-panel { flex: 1; min-width: 350px; background: var(--card-bg); padding: 0; border-radius: 12px; }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .month-display { font-size: 1.2em; font-weight: bold; color: #fff; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
    .day-cell {
      background: #333; aspect-ratio: 1.2 / 1; display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start; padding-top: 5px; cursor: pointer; border-radius: 4px;
    }
    .day-cell:hover { background: #444; border: 1px solid var(--primary-color); }
    .day-cell.other-month { opacity: 0.3; pointer-events: none; }
    .day-cell.selected { background: #2d4561; border: 2px solid var(--primary-color); }
    .day-cell.today .day-number { color: var(--primary-color); font-weight: bold; text-decoration: underline; }
    .event-dots { display: flex; gap: 2px; justify-content: center; flex-wrap: wrap; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background-color: var(--accent-color); }
    .dot.many { background-color: #ff9f43; } 
    
    .sch-item-card { background: #333; border: 1px solid #444; border-radius: 8px; padding: 15px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 6px; position:relative; }
    .sch-team { font-size: 0.9em; color: var(--primary-color); font-weight: bold; }
    .sch-work { font-size: 1.1em; font-weight: bold; color: #fff; line-height: 1.3; }
    .sch-meta { font-size: 0.85em; color: #ccc; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }
    .sch-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 4px; }
    .sch-note { font-size: 0.85em; color: #aaa; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #555; }

    /* ë°œì£¼ì •ë³´ ì¹´ë“œ */
    .od-item-card { background: #252525; border: 1px solid #444; border-radius: 12px; padding: 20px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 12px; }
    .od-header { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .od-tag { background: #333; color: #bbb; border: 1px solid #555; padding: 3px 8px; border-radius: 6px; font-size: 0.85em; }
    .od-title { font-size: 1.2em; font-weight: bold; color: #fff; flex-grow: 1; }
    .od-body { display: flex; flex-direction: column; gap: 8px; font-size: 0.95em; }
    .od-block { display: flex; align-items: flex-start; gap: 8px; }
    .od-label { min-width: 70px; font-weight: bold; text-align: right; margin-top: 2px; }
    .od-value { color: #e0e0e0; line-height: 1.4; word-break: break-all; }
    .od-link { color: var(--success-color); font-weight: bold; text-decoration: underline; cursor: pointer; }
    .od-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; padding-top: 10px; border-top: 1px dashed #444; }
    .od-actions { display: flex; gap: 8px; align-items: center; }

    /* ì ê²€ì¼ì§€ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .cl-item-card { 
        background: #252525; border: 1px solid #444; border-radius: 12px; padding: 20px; 
        margin-bottom: 20px; display: flex; flex-direction: column; gap: 12px; 
    }
    .cl-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .cl-header-left { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .cl-team { color: var(--primary-color); font-weight: bold; font-size: 1.1em; }
    .cl-date { color: #aaa; font-size: 0.9em; }
    .cl-content-box { 
        background: #2f2f2f; padding: 15px; border-radius: 4px; color: #fff; 
        white-space: pre-wrap; line-height: 1.6; font-size: 1.05em; 
        border: 1px solid #444; border-left: 5px solid var(--accent-color);
        box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
    }
    .cl-footer { 
        display: flex; flex-direction: column; gap: 8px; margin-top: 5px; 
        padding-top: 10px; border-top: 1px dashed #444; font-size: 0.9em; 
    }
    .cl-mat-row { display: flex; align-items: flex-start; gap: 8px; }
    .cl-mat-label { font-weight: bold; min-width: 80px; text-align: right; }

    /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
    .mobile-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px);
    }
    @media (max-width: 768px) {
      .sidebar { position: fixed; top: 0; left: -100%; height: 100%; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
      .sidebar.active { left: 0; }
      .mobile-overlay.active { display: block; }
      .hamburger-btn { display: block; }
      .top-bar { padding: 0 15px; }
      .content-area { padding: 15px; }
    }

    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #121212; z-index: 9999; 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .login-box {
      background: var(--card-bg); padding: 40px; border-radius: 12px;
      border: 1px solid var(--primary-color); text-align: center;
      box-shadow: 0 0 20px rgba(74, 144, 226, 0.3); width: 300px;
    }
    .login-box h2 { color: #fff; margin-bottom: 20px; }
    .login-input { 
      width: 100%; padding: 12px; margin-bottom: 15px; 
      background: #333; border: 1px solid #555; color: #fff; font-size: 16px; border-radius: 4px;
      box-sizing: border-box;
    }
    .login-btn {
      width: 100%; padding: 12px; font-size: 16px; font-weight: bold;
      background: var(--primary-color); color: #fff; border: none; border-radius: 4px; cursor: pointer;
    }
    .login-btn:hover { background: var(--primary-hover); }

    .admin-only { display: none !important; }
    body.is-admin .admin-only { display: inline-block !important; }
    body.is-admin div.admin-only { display: block !important; }
  </style>
</head>
<body>

<div id="loginOverlay">
  <div class="login-box">
    <h2>ğŸ”’ ì‹œìŠ¤í…œ ì ‘ì†</h2>
    <p style="color:#aaa; margin-bottom:20px;">(ì£¼)ì˜ì„ ê¸°ê³„ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
    <input type="password" id="loginPw" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" onkeyup="if(window.event.keyCode==13){tryLogin()}">
    <button onclick="tryLogin()" class="login-btn">ë¡œê·¸ì¸</button>
    <p id="loginMsg" style="color: #ff6b6b; margin-top: 15px; font-size: 0.9em;"></p>
    <div style="margin-top:20px; font-size:0.8em; color:#666;">
        ë¬¸ì˜ì²˜ : ê¹€ê´‘ë¯¼ ì°¨ì¥(010-8947-4818)
    </div>
  </div>
</div>

<div class="app-container">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>(ì£¼)ì˜ì„ ê¸°ê³„</h2>
      <span class="sub-text">í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ v6.9.2</span>
    </div>
    <nav class="nav-menu">
      <div class="nav-group-label">ë©”ì¸ ì—…ë¬´</div>
      <a class="nav-item active" onclick="switchTab('schedule')"><span class="nav-icon">ğŸ“…</span> ì¼ì •ê´€ë¦¬</a>
      <a class="nav-item" onclick="switchTab('checklist')"><span class="nav-icon">ğŸ“‹</span> ì ê²€ì¼ì§€</a> 
      <a class="nav-item" onclick="switchTab('prework')"><span class="nav-icon">ğŸ“</span> ì„ ì‘ì—… ê´€ë¦¬</a>
      <a class="nav-item" onclick="switchTab('delivery')"><span class="nav-icon">ğŸšš</span> ë‚©í’ˆê´€ë¦¬</a>
      <a class="nav-item" onclick="switchTab('order')"><span class="nav-icon">ğŸ“¦</span> ë°œì£¼ì •ë³´</a>
      <div class="nav-group-label">ê¸°ì¤€ ì •ë³´</div>
      <a class="nav-item" onclick="switchTab('equipment')"><span class="nav-icon">ğŸ“„</span> ì„¤ë¹„ê´€ë¦¬</a>
      <a class="nav-item" onclick="switchTab('bucket')"><span class="nav-icon">ğŸª£</span> ë²„ì¼“ì£¼ê¸°</a>
      <a class="nav-item" onclick="switchTab('phonebook')"><span class="nav-icon">ğŸ“</span> ì „í™”ë²ˆí˜¸ë¶€</a>
      <div class="nav-group-label">ê´€ë ¨ ë§í¬</div>
      <a href="https://she-p.koreazinc.co.kr" target="_blank" class="nav-item"><span class="nav-icon">ğŸ› ï¸</span> í—ˆê°€ì‹ ì²­</a>
      <a href="https://kzems.koreazinc.co.kr" target="_blank" class="nav-item"><span class="nav-icon">ğŸšª</span> ì¶œì…ê´€ë¦¬</a>
    </nav>
    <div class="sidebar-footer">
      <div id="currentDateDisplay" style="margin-bottom:5px; font-weight:bold; color:#fff;"></div>
      <div style="font-size:0.75em; color:#666;">Â© 2025 Youngsun Machine</div>
    </div>
  </aside>
  
  <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

  <main class="main-content">
    <header class="top-bar">
      <div style="display:flex; align-items:center; gap:15px;">
        <button class="hamburger-btn" onclick="toggleSidebar()">â˜°</button>
        <h3 style="margin:0; border:none; padding:0; font-size:1.1rem;" id="pageTitle">ì¼ì •ê´€ë¦¬</h3>
      </div>
    </header>

    <div class="content-area">
      <div id="schedule" class="tab-content active">
        <div class="card admin-only" id="scheduleInlineFormCard">
          <h3>ì¼ì • ë“±ë¡</h3>
          <form id="scheduleForm" class="flex-row">
            <input type="date" name="ë‚ ì§œ" id="inputDate" required />
            <input type="text" name="ìƒì‚°íŒ€" id="i_schTeam" placeholder="ìƒì‚°íŒ€" required />
            <input type="text" name="ì‘ì—…ë‚´ìš©" id="i_schWork" placeholder="ì‘ì—…ë‚´ìš©" required />
            <input type="text" name="ë‹´ë‹¹ì" id="i_schManager" placeholder="ë‹´ë‹¹ì" required />
            <input type="text" name="ë°œì£¼ë²ˆí˜¸" id="i_schOrderNo" placeholder="ë°œì£¼ë²ˆí˜¸" required />
            <input type="text" name="í•„ìˆ˜ìì¬" id="i_schMat" placeholder="í•„ìˆ˜ìì¬" />
            <input type="text" name="í—ˆê°€ë²ˆí˜¸" id="i_schPermit" placeholder="í—ˆê°€ë²ˆí˜¸" />
            <input type="text" name="ë¹„ê³ " placeholder="ë¹„ê³ " />
            <input type="text" name="ì„¤ë¹„ID" id="i_schEqId" placeholder="ì„¤ë¹„ID (ì˜ˆ:KC-01)" />
            <button type="submit" class="btn-primary">ì¶”ê°€</button>
          </form>
        </div>
        <div class="card">
          <div class="flex-row" style="justify-content: flex-start; margin-bottom: 15px;">
            <button id="calendarViewBtn" onclick="toggleScheduleView('calendar')" style="background:#555;">ğŸ“… ë‹¬ë ¥</button>
            <button class="btn-primary" id="listViewBtn" onclick="toggleScheduleView('list')" style="background:var(--primary-color);">ğŸ“ ëª©ë¡ ì „ì²´ë³´ê¸°</button>
          </div>
          <div id="scheduleListView">
            <div class="flex-row" style="justify-content: space-between;">
              <div class="flex-row">
                <input type="text" id="searchBox" placeholder="ğŸ” í†µí•© ê²€ìƒ‰..." style="width: 200px;" />
                <select id="sortKeySel">
                  <option value="ë‚ ì§œ">ë‚ ì§œìˆœ</option>
                  <option value="ìƒì‚°íŒ€">ìƒì‚°íŒ€ìˆœ</option>
                  <option value="ì‘ì—…ë‚´ìš©">ì‘ì—…ë‚´ìš©ìˆœ</option>
                </select>
                <button id="ascBtn">ì˜¤ë¦„ì°¨ìˆœ</button>
                <button id="descBtn">ë‚´ë¦¼ì°¨ìˆœ</button>
              </div>
              <div class="flex-row">
                <input type="date" id="startDate"> ~ <input type="date" id="endDate">
                <button id="filterBtn">ê¸°ê°„ ì¡°íšŒ</button>
                <button id="clearFilterBtn">ì´ˆê¸°í™”</button>
                <button id="summaryBtn" class="btn-primary" style="background:#2d8cf0;">ğŸ“Š ì°¨íŠ¸ ìš”ì•½</button>
              </div>
            </div>
            <div id="chartContainer" style="display:none; margin: 20px 0; height:300px;">
              <canvas id="scheduleChart"></canvas>
            </div>
            <div class="table-container">
              <table id="scheduleTable">
                <thead><tr><th>ë‚ ì§œ</th><th>ìƒì‚°íŒ€</th><th>ì‘ì—…ë‚´ìš©</th><th>ë‹´ë‹¹ì</th><th>ë°œì£¼ë²ˆí˜¸</th><th>í•„ìˆ˜ìì¬</th><th>í—ˆê°€ë²ˆí˜¸</th><th>ë¹„ê³ </th><th>ì„¤ë¹„ID</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="pagination" class="paginator"></div>
          </div>
          <div id="scheduleCalendarView" style="display:none;">
            <div class="split-view-container">
                <div class="calendar-panel">
                    <div class="calendar-header">
                        <button onclick="changeMonth(-1)" style="padding:4px 10px;">â—€</button>
                        <span class="month-display" id="currentMonthDisplay"></span>
                        <button onclick="changeMonth(1)" style="padding:4px 10px;">â–¶</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
                <div class="detail-panel">
                    <div class="detail-header">
                        <h3 style="margin:0" id="detailTitle">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
                        <button class="btn-primary admin-only" onclick="clickAddOnSelectedDate()" style="font-size:0.8em;">+ ì´ ë‚ ì§œì— ì¶”ê°€</button>
                    </div>
                    <div class="detail-list" id="detailListContainer">
                        <div class="empty-state">ğŸ‘ˆ ë‹¬ë ¥ì—ì„œ ë‚ ì§œë¥¼ í´ë¦­í•˜ì—¬<br>ì¼ì •ì„ í™•ì¸í•˜ì„¸ìš”.</div>
                    </div>
                </div>
            </div>
          </div>
        </div>
      </div>

      <div id="checklist" class="tab-content">
        <div class="card admin-only">
          <h3>ğŸ“‹ ì ê²€ì¼ì§€ ë“±ë¡</h3>
          <div class="flex-row">
            <input type="date" id="clDate" required>
            <input type="text" id="clTeam" placeholder="ìƒì‚°íŒ€">
            <input type="text" id="clEqId" placeholder="ì„¤ë¹„ID">
            <input type="text" id="clManager" placeholder="ë‹´ë‹¹ì">
          </div>
          <div class="flex-row">
             <input type="text" id="clMatOrder" placeholder="ğŸ›’ ì£¼ë¬¸ í•„ìš” ìì¬" style="border:1px solid var(--warning-color);">
             <input type="text" id="clMatStock" placeholder="ğŸ“¦ ë³´ìœ  ì¤‘ ìì¬" style="border:1px solid var(--success-color);">
          </div>
          <div class="flex-row" style="margin-top:10px;">
             <input type="text" id="clContent" placeholder="ì ê²€ë‚´ìš© (ê°„ëµíˆ ì…ë ¥ í›„ ìˆ˜ì • ì¶”ì²œ)" style="flex-grow:1; width:100%;">
             <button onclick="saveChecklist()" class="btn-primary" style="white-space:nowrap;">ë“±ë¡</button>
          </div>
        </div>
        <div class="card">
          <div class="flex-row" style="justify-content: flex-start;">
            <input type="text" id="clSearch" placeholder="ğŸ” ê²€ìƒ‰ (ì„¤ë¹„ID, ì ê²€ë‚´ìš©, ìì¬)" style="width: 250px;">
            <select id="clSortSel">
              <option value="ë‚ ì§œ">ë‚ ì§œìˆœ</option>
              <option value="ìƒì‚°íŒ€">ìƒì‚°íŒ€ìˆœ</option>
              <option value="ì„¤ë¹„ID">ì„¤ë¹„IDìˆœ</option>
            </select>
          </div>
          <div id="checklistContainer" style="margin-top:15px;"></div>
          <div id="clPagination" class="paginator"></div>
        </div>
      </div>

      <div id="prework" class="tab-content">
        <div class="card admin-only">
            <h3>ğŸ“ ì„ ì‘ì—… ë“±ë¡</h3>
            <div class="flex-row">
                <input type="date" id="pwDate" required>
                <input type="text" id="pwTeam" placeholder="ìƒì‚°íŒ€">
                <input type="text" id="pwManager" placeholder="ë‹´ë‹¹ì">
                <input type="text" id="pwWork" placeholder="ì‘ì—…ë‚´ìš©">
                <button onclick="savePrework()" class="btn-primary">ë“±ë¡</button>
            </div>
        </div>
        <div class="card">
            <div class="flex-row" style="justify-content: flex-start;">
                <input type="text" id="pwSearch" placeholder="ğŸ” ê²€ìƒ‰ (ì‘ì—…ë‚´ìš©)" style="width: 250px;">
                <select id="pwSortSel">
                    <option value="ë‚ ì§œ">ë‚ ì§œìˆœ</option>
                    <option value="ìƒì‚°íŒ€">ìƒì‚°íŒ€ìˆœ</option>
                    <option value="ì‘ì—…ë‚´ìš©">ì‘ì—…ë‚´ìš©ìˆœ</option>
                </select>
            </div>
            <div class="table-container">
                <table id="pwTable">
                    <thead>
                        <tr><th>ë‚ ì§œ</th><th>ìƒì‚°íŒ€</th><th>ë‹´ë‹¹ì</th><th>ì‘ì—…ë‚´ìš©</th><th style="text-align:center;">ì§„í–‰ìƒíƒœ</th><th>ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="pwPagination" class="paginator"></div>
        </div>
      </div>

      <div id="delivery" class="tab-content">
        <div class="card admin-only">
            <h3>ğŸšš ë‚©í’ˆ ì •ë³´ ë“±ë¡</h3>
            <div class="flex-row">
                <input type="date" id="dlDate" required>
                <input type="text" id="dlOrderNo" placeholder="ë°œì£¼ë²ˆí˜¸">
                <input type="text" id="dlTeam" placeholder="ìƒì‚°íŒ€">
                <input type="text" id="dlManager" placeholder="ë‹´ë‹¹ì">
                <input type="text" id="dlProject" placeholder="ê³µì‚¬ëª…">
                <input type="text" id="dlContent" placeholder="ë‚©í’ˆë‚´ìš©">
                <button onclick="saveDelivery()" class="btn-primary">ë“±ë¡</button>
            </div>
        </div>
        <div class="card">
            <div class="flex-row" style="justify-content: flex-start;">
                <input type="text" id="dlSearch" placeholder="ğŸ” ê²€ìƒ‰ (ê³µì‚¬ëª…, ë‚©í’ˆë‚´ìš©)" style="width: 250px;">
                <select id="dlSortSel">
                    <option value="ë‚ ì§œ">ë‚ ì§œìˆœ</option>
                    <option value="ìƒì‚°íŒ€">ìƒì‚°íŒ€ìˆœ</option>
                    <option value="ë‚©í’ˆë‚´ìš©">ë‚©í’ˆë‚´ìš©ìˆœ</option>
                </select>
            </div>
            <div class="table-container">
                <table id="dlTable">
                    <thead>
                        <tr><th>ë°œì£¼ë‚ ì§œ</th><th>ë°œì£¼ë²ˆí˜¸</th><th>ìƒì‚°íŒ€</th><th>ë‹´ë‹¹ì</th><th>ê³µì‚¬ëª…</th><th>ë‚©í’ˆë‚´ìš©</th><th style="text-align:center;">ì§„í–‰ìƒíƒœ</th><th>ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="dlPagination" class="paginator"></div>
        </div>
      </div>

      <div id="order" class="tab-content">
        <div class="card admin-only">
          <h3>ë°œì£¼ ì •ë³´ ë“±ë¡</h3>
          <div class="flex-row">
            <input type="text" id="odBid" placeholder="ì…ì°°ë²ˆí˜¸">
            <input type="text" id="odReq" placeholder="ì˜ë¢°ë²ˆí˜¸">
            <input type="text" id="odPo" placeholder="êµ¬ë§¤POë²ˆí˜¸">
            <input type="text" id="odRequester" placeholder="ì˜ë¢°ì">
            <input type="text" id="odBuyer" placeholder="êµ¬ë§¤ë‹´ë‹¹ì">
            <input type="text" id="odProject" placeholder="ê³µì‚¬ëª…">
            <input type="text" id="odPermit" placeholder="ì‘ì—…ë‚´ìš©">
            <input type="text" id="odMat" placeholder="í•„ìˆ˜ìì¬">
            <input type="text" id="odPermitNo" placeholder="í—ˆê°€ë²ˆí˜¸">
            <button onclick="saveOrder()" class="btn-primary">ì €ì¥</button>
          </div>
        </div>
        <div class="card">
          <div class="flex-row">
            <input type="text" id="odSearch" placeholder="ğŸ” POë²ˆí˜¸/ê³µì‚¬ëª… ê²€ìƒ‰">
            <button id="odNewestBtn">ìµœì‹ ìˆœ</button>
            <button id="odOldestBtn">ì˜¤ë˜ëœìˆœ</button>
          </div>
          <div id="orderListContainer" style="margin-top:15px;"></div>
          <div id="odPagination" class="paginator"></div>
        </div>
      </div>

      <div id="equipment" class="tab-content">
        <div class="card admin-only">
          <h3>ì„¤ë¹„ ìŠ¤í™ ë“±ë¡</h3>
          <div class="flex-row">
            <input type="text" id="esTeam" placeholder="íŒ€ (ì˜ˆ: OF1íŒ€)">
            <input type="text" id="esEqId" placeholder="ì„¤ë¹„ ID (ì˜ˆ: KC-089)">
            <input type="text" id="esLocation" placeholder="ìœ„ì¹˜ (ì˜ˆ: Aë™ 3ì¸µ)">
            <button onclick="openSpecModal('new')" class="btn-primary">ğŸ“ ìŠ¤í™ ìƒì„¸ ì…ë ¥</button>
          </div>
        </div>
        <div class="card">
          <div class="filter-container">
              <select id="filterTeam"><option value="">ğŸ¢ ëª¨ë“  íŒ€</option></select>
              <select id="filterLoc"><option value="">ğŸ“ ëª¨ë“  ìœ„ì¹˜</option></select>
              <input type="text" id="esSearch" placeholder="ğŸ” ê²€ìƒ‰" style="flex-grow:1;">
              <button onclick="resetEquipmentFilter()" style="background:#555;">â†º ì´ˆê¸°í™”</button>
          </div>
          <div class="table-container">
            <table id="esTable">
              <thead><tr><th>íŒ€</th><th>ì„¤ë¹„ ID</th><th>ìœ„ì¹˜</th><th>ì„¸ë¶€ ìŠ¤í™</th><th>ê´€ë¦¬</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="esPagination" class="paginator"></div>
        </div>
      </div>

      <div id="bucket" class="tab-content">
        <div class="card">
          <div id="bkFilterContainer" class="bk-filter-container">
              </div>
          
          <div id="bkDashboard" class="bk-dashboard">
              </div>
        </div>
      </div>

      <div id="phonebook" class="tab-content">
        <div class="card admin-only">
          <h3>ì—°ë½ì²˜ ë“±ë¡</h3>
          <div class="flex-row">
            <input type="text" id="pbDept" placeholder="ë¶€ì„œ">
            <input type="text" id="pbPosition" placeholder="ì§ì±…">
            <input type="text" id="pbName" placeholder="ì´ë¦„">
            <input type="text" id="pbPhone" placeholder="ì „í™”ë²ˆí˜¸">
            <button onclick="savePhonebook()" class="btn-primary">ì €ì¥</button>
          </div>
        </div>
        <div class="card">
          <input type="text" id="pbSearch" placeholder="ğŸ” ê²€ìƒ‰" style="width:100%; max-width:300px; margin-bottom:10px;">
          <div class="table-container">
            <table id="pbTable">
              <thead><tr><th>ë¶€ì„œ</th><th>ì§ì±…</th><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th><th>ê´€ë¦¬</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="pbPagination" class="paginator"></div>
        </div>
      </div>
    </div>
  </main>
</div>

<div id="addScheduleModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸ“… ì¼ì • ë“±ë¡</h3><span class="close-modal" onclick="closeModal('addScheduleModal')">&times;</span></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="n_schDate"></div>
        <div class="form-group"><label>ìƒì‚°íŒ€</label><input type="text" id="n_schTeam"></div>
        <div class="form-group"><label>ì‘ì—…ë‚´ìš©</label><input type="text" id="n_schWork"></div>
        <div class="form-group"><label>ë‹´ë‹¹ì</label><input type="text" id="n_schManager"></div>
        <div class="form-group"><label>ë°œì£¼ë²ˆí˜¸</label><input type="text" id="n_schOrderNo"></div>
        <div class="form-group"><label>í•„ìˆ˜ìì¬</label><input type="text" id="n_schMat"></div>
        <div class="form-group"><label>í—ˆê°€ë²ˆí˜¸</label><input type="text" id="n_schPermit"></div>
        <div class="form-group"><label>ë¹„ê³ </label><input type="text" id="n_schNote"></div>
        <div class="form-group"><label>ì„¤ë¹„ID</label><input type="text" id="n_schEqId"></div>
      </div>
    </div>
    <div class="modal-footer"><button onclick="closeModal('addScheduleModal')">ì·¨ì†Œ</button><button onclick="saveNewScheduleFromModal()" class="btn-primary admin-only">ë“±ë¡ ì™„ë£Œ</button></div>
  </div>
</div>

<div id="scheduleModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸ“… ì¼ì • ìˆ˜ì •</h3><span class="close-modal" onclick="closeModal('scheduleModal')">&times;</span></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="m_schDate"></div>
        <div class="form-group"><label>ìƒì‚°íŒ€</label><input type="text" id="m_schTeam"></div>
        <div class="form-group"><label>ì‘ì—…ë‚´ìš©</label><input type="text" id="m_schWork"></div>
        <div class="form-group"><label>ë‹´ë‹¹ì</label><input type="text" id="m_schManager"></div>
        <div class="form-group"><label>ë°œì£¼ë²ˆí˜¸</label><input type="text" id="m_schOrderNo"></div>
        <div class="form-group"><label>í•„ìˆ˜ìì¬</label><input type="text" id="m_schMat"></div>
        <div class="form-group"><label>í—ˆê°€ë²ˆí˜¸</label><input type="text" id="m_schPermit"></div>
        <div class="form-group"><label>ë¹„ê³ </label><input type="text" id="m_schNote"></div>
        <div class="form-group"><label>ì„¤ë¹„ID</label><input type="text" id="m_schEqId"></div>
      </div>
    </div>
    <div class="modal-footer"><button onclick="closeModal('scheduleModal')">ì·¨ì†Œ</button><button onclick="saveScheduleFromModal()" class="btn-primary admin-only">ìˆ˜ì • ì €ì¥</button></div>
  </div>
</div>

<div id="checklistModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸ“‹ ì ê²€ì¼ì§€ ìˆ˜ì •</h3><span class="close-modal" onclick="closeModal('checklistModal')">&times;</span></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="m_clDate"></div>
        <div class="form-group"><label>ìƒì‚°íŒ€</label><input type="text" id="m_clTeam"></div>
        <div class="form-group"><label>ì„¤ë¹„ID</label><input type="text" id="m_clEqId"></div>
        <div class="form-group"><label>ë‹´ë‹¹ì</label><input type="text" id="m_clManager"></div>
        <div class="form-group"><label style="color:var(--warning-color)">ğŸ›’ ì£¼ë¬¸ í•„ìš” ìì¬</label><input type="text" id="m_clMatOrder"></div>
        <div class="form-group"><label style="color:var(--success-color)">ğŸ“¦ ë³´ìœ  ì¤‘ ìì¬</label><input type="text" id="m_clMatStock"></div>
      </div>
      <div class="form-group" style="margin-top:15px;">
        <label>ì ê²€ë‚´ìš© (ìƒì„¸)</label>
        <textarea id="m_clContent" rows="8" style="width:100%;"></textarea>
      </div>
      <div class="form-group" style="margin-top:15px;">
          <label style="color:var(--primary-color); font-weight:bold;">ìƒíƒœ í™•ì¸</label>
          <div class="checkbox-group">
             <label><input type="checkbox" id="m_clChkOrder"> ìì¬ ì£¼ë¬¸ ìš”ì²­ ì™„ë£Œ</label>
             <label><input type="checkbox" id="m_clChkStock"> ë³´ìœ  ìì¬ ì¤€ë¹„ ì™„ë£Œ</label>
          </div>
      </div>
    </div>
    <div class="modal-footer"><button onclick="closeModal('checklistModal')">ì·¨ì†Œ</button><button onclick="saveChecklistFromModal()" class="btn-primary admin-only">ìˆ˜ì • ì €ì¥</button></div>
  </div>
</div>

<div id="preworkModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ“ ì„ ì‘ì—… ìˆ˜ì •</h3><span class="close-modal" onclick="closeModal('preworkModal')">&times;</span></div><div class="modal-body"><div class="form-grid"><div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="m_pwDate"></div><div class="form-group"><label>ìƒì‚°íŒ€</label><input type="text" id="m_pwTeam"></div><div class="form-group"><label>ë‹´ë‹¹ì</label><input type="text" id="m_pwManager"></div><div class="form-group"><label>ì‘ì—…ë‚´ìš©</label><input type="text" id="m_pwWork"></div><div class="form-group"><label style="color:var(--primary-color); font-weight:bold;">ìƒíƒœ ì²´í¬</label><div class="checkbox-group" style="flex-wrap:wrap"><label><input type="checkbox" id="m_pwChk1"> ì‘ì—…ì™„ë£Œ</label><label><input type="checkbox" id="m_pwChk2"> ë‚´ìš©ì „ë‹¬</label><label><input type="checkbox" id="m_pwChk3"> ì…ì°°ì™„ë£Œ</label><label><input type="checkbox" id="m_pwChk4"> ë°œì£¼ì™„ë£Œ</label></div></div></div></div><div class="modal-footer"><button onclick="closeModal('preworkModal')">ì·¨ì†Œ</button><button onclick="savePreworkFromModal()" class="btn-primary admin-only">ìˆ˜ì • ì €ì¥</button></div></div></div>

<div id="deliveryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸšš ë‚©í’ˆ ì •ë³´ ìˆ˜ì •</h3><span class="close-modal" onclick="closeModal('deliveryModal')">&times;</span></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>ë°œì£¼ë‚ ì§œ</label><input type="date" id="m_dlDate"></div>
        <div class="form-group"><label>ë°œì£¼ë²ˆí˜¸</label><input type="text" id="m_dlOrderNo"></div>
        <div class="form-group"><label>ìƒì‚°íŒ€</label><input type="text" id="m_dlTeam"></div>
        <div class="form-group"><label>ë‹´ë‹¹ì</label><input type="text" id="m_dlManager"></div>
        <div class="form-group"><label>ê³µì‚¬ëª…</label><input type="text" id="m_dlProject"></div>
        <div class="form-group"><label>ë‚©í’ˆë‚´ìš©</label><input type="text" id="m_dlContent"></div>
        <div class="form-group">
          <label style="color:var(--primary-color); font-weight:bold;">ì§„í–‰ ìƒíƒœ</label>
          <div class="checkbox-group" style="flex-wrap:wrap">
            <label><input type="checkbox" id="m_dlChk1"> ë°œì£¼í™•ì¸</label>
            <label><input type="checkbox" id="m_dlChk2"> ì£¼ë¬¸ì™„ë£Œ</label>
            <label><input type="checkbox" id="m_dlChk3"> ì…ê³ ì™„ë£Œ</label>
            <label><input type="checkbox" id="m_dlChk4"> ë‚©í’ˆì™„ë£Œ</label>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer"><button onclick="closeModal('deliveryModal')">ì·¨ì†Œ</button><button onclick="saveDeliveryFromModal()" class="btn-primary admin-only">ìˆ˜ì • ì €ì¥</button></div>
  </div>
</div>

<div id="orderModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ“¦ ë°œì£¼ ì •ë³´ ìˆ˜ì •</h3><span class="close-modal" onclick="closeModal('orderModal')">&times;</span></div><div class="modal-body"><div class="form-grid"><div class="form-group"><label>ì…ì°°ë²ˆí˜¸</label><input type="text" id="m_odBid"></div><div class="form-group"><label>ì˜ë¢°ë²ˆí˜¸</label><input type="text" id="m_odReq"></div><div class="form-group"><label>êµ¬ë§¤POë²ˆí˜¸</label><input type="text" id="m_odPo"></div><div class="form-group"><label>ì˜ë¢°ì</label><input type="text" id="m_odRequester"></div><div class="form-group"><label>êµ¬ë§¤ë‹´ë‹¹ì</label><input type="text" id="m_odBuyer"></div><div class="form-group"><label>ê³µì‚¬ëª…</label><input type="text" id="m_odProject"></div><div class="form-group"><label>ì‘ì—…ë‚´ìš©</label><input type="text" id="m_odPermit"></div><div class="form-group"><label>í•„ìˆ˜ìì¬</label><input type="text" id="m_odMat"></div><div class="form-group"><label>í—ˆê°€ë²ˆí˜¸</label><input type="text" id="m_odPermitNo"></div><div class="form-group"><label style="color:var(--primary-color); font-weight:bold;">ì§„í–‰ ìƒíƒœ ì²´í¬</label><div class="checkbox-group"><label><input type="checkbox" id="m_odPermitCheck"> í—ˆê°€ë°œí–‰</label><label><input type="checkbox" id="m_odDoneCheck"> ì‘ì—…ì™„ë£Œ</label></div></div></div></div><div class="modal-footer"><button onclick="closeModal('orderModal')">ì·¨ì†Œ</button><button onclick="saveOrderFromModal()" class="btn-primary admin-only">ìˆ˜ì • ì €ì¥</button></div></div></div>

<div id="phoneModal" class="modal"><div class="modal-content" style="max-width:500px;"><div class="modal-header"><h3>ğŸ“ ì—°ë½ì²˜ ìˆ˜ì •</h3><span class="close-modal" onclick="closeModal('phoneModal')">&times;</span></div><div class="modal-body"><div class="form-grid" style="grid-template-columns: 1fr;"><div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="m_pbDept"></div><div class="form-group"><label>ì§ì±…</label><input type="text" id="m_pbPos"></div><div class="form-group"><label>ì´ë¦„</label><input type="text" id="m_pbName"></div><div class="form-group"><label>ì „í™”ë²ˆí˜¸</label><input type="text" id="m_pbPhone"></div></div></div><div class="modal-footer"><button onclick="closeModal('phoneModal')">ì·¨ì†Œ</button><button onclick="savePhoneFromModal()" class="btn-primary admin-only">ìˆ˜ì • ì €ì¥</button></div></div></div>

<div id="addBucketEntryModal" class="modal">
  <div class="modal-content" style="width: 500px; max-width: 90%; height: auto;">
    <div class="modal-header">
        <h3 id="addBucketTitle">ğŸª£ êµì²´ ê¸°ë¡ ë“±ë¡</h3>
        <span class="close-modal" onclick="closeModal('addBucketEntryModal')">&times;</span>
    </div>
    <div class="modal-body" style="overflow: visible;">
        <input type="hidden" id="n_bkDept"> <div class="form-group" style="margin-bottom:15px;">
            <label>êµì²´ ë‚ ì§œ</label>
            <input type="date" id="n_bkDate" style="width:100%;">
        </div>
        <div class="form-group">
            <label>ë¹„ê³ </label>
            <input type="text" id="n_bkNote" placeholder="ë‚´ìš© ì…ë ¥" style="width:100%;">
        </div>
    </div>
    <div class="modal-footer">
        <button onclick="closeModal('addBucketEntryModal')">ì·¨ì†Œ</button>
        <button onclick="submitBucketEntry()" class="btn-primary admin-only">ì €ì¥</button>
    </div>
  </div>
</div>

<div id="specModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>ğŸ”§ ì„¤ë¹„ ìƒì„¸ ìŠ¤í™ í¸ì§‘</h3><span class="close-modal" onclick="closeModal('specModal')">&times;</span></div><div class="modal-body"><div id="modalMetaInfo" style="margin-bottom:15px; color:var(--primary-color); font-weight:bold;"></div><div id="specBasicInfo" class="form-grid" style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:15px;"><div class="form-group"><label>íŒ€</label><input type="text" id="m_esTeam_modal"></div><div class="form-group"><label>ì„¤ë¹„ID</label><input type="text" id="m_esEqId_modal"></div><div class="form-group"><label>ìœ„ì¹˜</label><input type="text" id="m_esLocation_modal"></div></div><table class="spec-table" id="modalSpecTable" style="width:100%; margin-bottom:15px; border-collapse:collapse;"><thead><tr><th style="width:40%">í•­ëª©ëª… (Key)</th><th style="width:40%">ê°’ (Value)</th><th style="width:20%">ì‚­ì œ</th></tr></thead><tbody></tbody></table><button onclick="addModalRow()" style="width:100%; border:1px dashed #555;" class="admin-only">+ í•­ëª© ì¶”ê°€</button></div><div class="modal-footer"><button onclick="closeModal('specModal')">ì·¨ì†Œ</button><button onclick="saveSpecFromModal()" class="btn-primary admin-only">ìˆ˜ì • ì €ì¥</button></div></div></div>

<script>
  // [ì¤‘ìš”] ë°˜ë“œì‹œ ë³¸ì¸ì˜ ìµœì‹  Web App URLë¡œ êµì²´í•˜ì„¸ìš”!
  const API_URL = "https://script.google.com/macros/s/AKfycbzmfoImopW4qx0Pdi2sz5-Jj-TN5BK0y4o1tI2JpNlTwOvd7ZIbxDR1fik022sTlS1SVg/exec";
  
  /* --- [ë³´ì•ˆ] ë¡œê·¸ì¸ ì„¤ì • --- */
  const PW_ADMIN = "1984"; 
  const PW_VIEWER = "0000"; 

  function tryLogin() {
    const input = document.getElementById('loginPw').value;
    const msg = document.getElementById('loginMsg');
    
    if (input === PW_ADMIN) {
      document.body.classList.add('is-admin'); 
      document.getElementById('loginOverlay').style.display = 'none';
    } else if (input === PW_VIEWER) {
      document.body.classList.remove('is-admin'); 
      document.getElementById('loginOverlay').style.display = 'none';
    } else {
      msg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      document.getElementById('loginPw').value = "";
      document.getElementById('loginPw').focus();
    }
  }

  const getTodayStr = () => { const d = new Date(); const pad = n => n<10 ? '0'+n : n; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
  const TODAY_DATE_STR = getTodayStr(); document.getElementById('currentDateDisplay').textContent = TODAY_DATE_STR;

  /* --- UI ì œì–´ --- */
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobileOverlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
  }

  function switchTab(tabId) { 
      document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active')); 
      document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active')); 
      document.getElementById(tabId).classList.add('active'); 
      const idx = ['schedule','checklist','prework','delivery','order','equipment','bucket','phonebook'].indexOf(tabId); 
      const navItems = document.querySelectorAll('.nav-item');
      if(idx>=0 && navItems[idx]) navItems[idx].classList.add('active'); 
      if(window.innerWidth <= 768) { toggleSidebar(); }
      const titles = {'schedule':'ğŸ“… ì¼ì •ê´€ë¦¬', 'checklist':'ğŸ“‹ ì ê²€ì¼ì§€', 'prework':'ğŸ“ ì„ ì‘ì—… ê´€ë¦¬', 'delivery':'ğŸšš ë‚©í’ˆê´€ë¦¬', 'order':'ğŸ“¦ ë°œì£¼ì •ë³´', 'equipment':'ğŸ“„ ì„¤ë¹„ê´€ë¦¬', 'bucket':'ğŸª£ ë²„ì¼“ì£¼ê¸°', 'phonebook':'ğŸ“ ì „í™”ë²ˆí˜¸ë¶€'};
      document.getElementById('pageTitle').textContent = titles[tabId];
  }

  function formatDate(v) { if (!v) return ""; try { const d = new Date(v); if (isNaN(d.getTime())) return v; const pad = n => n<10 ? '0'+n : n; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; } catch { return v; } }
  function renderPaginator(divId, totalPages, callback, currentPage){ const div = document.getElementById(divId); div.innerHTML = ""; if(totalPages < 2) return; let startP = Math.max(1, currentPage - 2); let endP = Math.min(totalPages, startP + 4); for(let i=startP; i<=endP; i++){ const b = document.createElement("button"); b.textContent = i; if(i === currentPage) b.classList.add("active"); b.onclick = () => callback(i); div.appendChild(b); } }
  function openModal(id) { document.getElementById(id).classList.add('show'); }
  function closeModal(id) { document.getElementById(id).classList.remove('show'); }
  let currentSchRow=null, currentPbRow=null, currentBkRow=null, currentOdRow=null, currentPwRow=null, currentDlRow=null, currentClRow=null; 
  function normalizeBool(val) { if (val === true || val === false) return val; if (!val) return false; const str = String(val).trim().toUpperCase(); return str === 'TRUE' || str === 'í—ˆê°€' || str === 'ì™„ë£Œ'; }

  /* ================= 1. ì¼ì •ê´€ë¦¬ (Smart Sync ì ìš©) ================= */
  const schedulePageSize=10; 
  const FIELDS=["ë‚ ì§œ","ìƒì‚°íŒ€","ì‘ì—…ë‚´ìš©","ë‹´ë‹¹ì","ë°œì£¼ë²ˆí˜¸","í•„ìˆ˜ìì¬","í—ˆê°€ë²ˆí˜¸","ë¹„ê³ ","ì„¤ë¹„ID"];
  let schedulePage=1, records=[], searchQuery="", sortKey="ë‚ ì§œ", sortAsc=true, dateFilter={start:null, end:null}; 
  let scheduleChartInstance = null; let currentView = 'list'; let currentCalendarDate = new Date(); let selectedDate = TODAY_DATE_STR; 

  function toggleScheduleView(view) {
      currentView = view;
      document.getElementById('scheduleListView').style.display = view === 'list' ? 'block' : 'none';
      document.getElementById('scheduleCalendarView').style.display = view === 'calendar' ? 'block' : 'none';
      document.getElementById('scheduleInlineFormCard').style.display = view === 'list' ? 'block' : 'none'; 
      document.getElementById('listViewBtn').style.background = view === 'list' ? 'var(--primary-color)' : '#555';
      document.getElementById('calendarViewBtn').style.background = view === 'calendar' ? 'var(--primary-color)' : '#555';
      if (view === 'calendar') { renderCalendar(); updateDetailPanel(selectedDate); } else { renderSchedule(); }
  }
  
  function goToEquipmentSpec(eqId) {
    if(!eqId) return;
    switchTab('equipment'); 
    const searchInput = document.getElementById('esSearch');
    searchInput.value = eqId; 
    searchInput.dispatchEvent(new Event('input')); 
  }

  function changeMonth(delta) { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta); renderCalendar(); }
  function clickAddOnSelectedDate() {
      ['n_schTeam','n_schWork','n_schManager','n_schOrderNo','n_schMat','n_schPermit','n_schNote','n_schEqId'].forEach(id=>document.getElementById(id).value="");
      document.getElementById('n_schDate').value = selectedDate; openModal('addScheduleModal');
  }
  
  async function saveNewScheduleFromModal(){
      const date = document.getElementById('n_schDate').value, team = document.getElementById('n_schTeam').value;
      const eqId = document.getElementById('n_schEqId').value;
      const work = document.getElementById('n_schWork').value, manager = document.getElementById('n_schManager').value;
      const orderNo = document.getElementById('n_schOrderNo').value, mat = document.getElementById('n_schMat').value;
      const permit = document.getElementById('n_schPermit').value, note = document.getElementById('n_schNote').value;
      if(!date || !team || !work || !manager) { alert("ë‚ ì§œ, íŒ€, ì‘ì—…, ë‹´ë‹¹ìëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
      await fetch(API_URL, { method: "POST", body: JSON.stringify({ 
          action: "add", "ë‚ ì§œ": date, "ìƒì‚°íŒ€": team, "ì„¤ë¹„ID": eqId, 
          "ì‘ì—…ë‚´ìš©": work, "ë‹´ë‹¹ì": manager, "ë°œì£¼ë²ˆí˜¸": orderNo, 
          "í•„ìˆ˜ìì¬": mat, "í—ˆê°€ë²ˆí˜¸": permit, "ë¹„ê³ ": note 
      }) });
      closeModal('addScheduleModal'); loadSchedule(); 
  }

  function renderCalendar() {
      const grid = document.getElementById('calendarGrid'); grid.innerHTML="";
      const year = currentCalendarDate.getFullYear(); const month = currentCalendarDate.getMonth();
      document.getElementById('currentMonthDisplay').textContent = `${year}ë…„ ${month + 1}ì›”`;
      const firstDay = new Date(year, month, 1).getDay(); const lastDate = new Date(year, month + 1, 0).getDate();
      const schedulesByDate = records.reduce((acc, r) => { const dateStr = formatDate(r["ë‚ ì§œ"]); if (dateStr) { if (!acc[dateStr]) acc[dateStr] = []; acc[dateStr].push(r); } return acc; }, {});
      for (let i = 0; i < firstDay; i++) { grid.innerHTML += `<div class="day-cell other-month"></div>`; }
      for (let i = 1; i <= lastDate; i++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          const isToday = dateStr === TODAY_DATE_STR; const isSelected = dateStr === selectedDate;
          const list = schedulesByDate[dateStr] || [];
          let dotsHtml = ''; if(list.length>0) { dotsHtml='<div class="event-dots">'; for(let k=0;k<Math.min(list.length,4);k++) dotsHtml+=`<div class="dot ${list.length>4?'many':''}"></div>`; dotsHtml+='</div>'; }
          const cell = document.createElement("div"); cell.className = `day-cell ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}`;
          cell.innerHTML = `<span class="day-number">${i}</span>${dotsHtml}`;
          cell.onclick = () => { selectedDate = dateStr; renderCalendar(); updateDetailPanel(dateStr); };
          grid.appendChild(cell);
      }
  }

  // ì„ ì‘ì—… ë“±ë¡ ì—¬ë¶€ í™•ì¸ìš© í—¬í¼ í•¨ìˆ˜
  function isPreworkRegistered(schRow) {
      if (!pwRowMap || pwRowMap.size === 0) return false;
      const schDate = formatDate(schRow["ë‚ ì§œ"]);
      const schTeam = schRow["ìƒì‚°íŒ€"];
      const schWork = schRow["ì‘ì—…ë‚´ìš©"];
      for (let [row, cells] of pwRowMap) {
          const pwDate = formatDate(cells[0]), pwTeam = cells[1], pwWork = cells[3];
          if (schDate === pwDate && schTeam === pwTeam && schWork === pwWork) return true;
      }
      return false;
  }

  function updateDetailPanel(dateStr) {
      document.getElementById('detailTitle').textContent = `${dateStr} ì¼ì • ëª©ë¡`;
      const container = document.getElementById('detailListContainer');
      const list = records.filter(r => formatDate(r["ë‚ ì§œ"]) === dateStr);
      if(list.length === 0) { container.innerHTML = `<div class="empty-state">ğŸ“… ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
      container.innerHTML = "";
      list.forEach(r => {
          const div = document.createElement("div"); div.className = "sch-item-card";
          let html = `<div class="sch-team">${r['ìƒì‚°íŒ€']}</div>`;
          if(r['ì„¤ë¹„ID']) html += `<div style="font-size:0.85em; color:var(--accent-color); cursor:pointer;" onclick="goToEquipmentSpec('${r['ì„¤ë¹„ID']}')">ğŸ”— ${r['ì„¤ë¹„ID']}</div>`;
          html += `<div class="sch-work">${r['ì‘ì—…ë‚´ìš©']}</div>`;
          let poHtml = r['ë°œì£¼ë²ˆí˜¸'] ? `<span class="link-text" onclick="searchOrderByPO('${r['ë°œì£¼ë²ˆí˜¸']}')">${r['ë°œì£¼ë²ˆí˜¸']}</span>` : '-';
          html += `<div class="sch-meta"><span>ğŸ‘¤ ${r['ë‹´ë‹¹ì']}</span><span class="sch-divider">|</span><span>ğŸ“¦ ${poHtml}</span>`;
          if(r['í—ˆê°€ë²ˆí˜¸']) { html += `<span class="sch-divider">|</span><span style="color:#81D4FA">ğŸ›¡ï¸ ${r['í—ˆê°€ë²ˆí˜¸']}</span>`; } html += `</div>`;
          if(r['í•„ìˆ˜ìì¬']) { html += `<div class="sch-mat">ğŸ› ï¸ ${r['í•„ìˆ˜ìì¬']}</div>`; }
          if(r['ë¹„ê³ ']) { html += `<div class="sch-note">ğŸ—’ï¸ ë¹„ê³ : ${r['ë¹„ê³ ']}</div>`; }
          
          const isRegistered = isPreworkRegistered(r);
          const btnClass = isRegistered ? "btn-prework registered" : "btn-prework";
          
          html += `<div class="sch-actions">
                    <button onclick='transferToPrework(${JSON.stringify(r)})' class="${btnClass} admin-only">ğŸ“ ì„ ì‘ì—…</button>
                    <button onclick="openScheduleModal(${r.row})" class="admin-only">âœï¸</button>
                    <button onclick="deleteRecord(${r.row})" class="btn-danger admin-only">ğŸ—‘ï¸</button>
                   </div>`;
          div.innerHTML = html; container.appendChild(div);
      });
  }

  async function loadSchedule(autoJumpToToday = false){
    try {
        const res = await fetch(API_URL+"?action=schedule_get"); const raw = await res.json();
        records = raw.slice(1).map((row,i) => { const o = {row: i+2}; FIELDS.forEach((k,idx) => o[k] = row[idx]??""); return o; });
        if (autoJumpToToday) { 
            selectedDate = TODAY_DATE_STR;
            const view = getScheduleView(); 
            const todayIdx = view.findIndex(r => formatDate(r["ë‚ ì§œ"]) === TODAY_DATE_STR);
            if (todayIdx !== -1) { schedulePage = Math.ceil((todayIdx + 1) / schedulePageSize); } else { schedulePage = 1; }
        }
        if(currentView === 'calendar') { renderCalendar(); updateDetailPanel(selectedDate); } else { renderSchedule(); }
    } catch(e) { console.error(e); }
  }

  function getScheduleView(){
    let view = records.filter(r => {
      if(searchQuery){ const hay = FIELDS.map(k=>r[k]??"").join(" ").toLowerCase(); if(!hay.includes(searchQuery.toLowerCase())) return false; }
      if(dateFilter.start || dateFilter.end){ const dStr = formatDate(r["ë‚ ì§œ"]); if(!dStr) return false; if(dateFilter.start && dStr < dateFilter.start) return false; if(dateFilter.end && dStr > dateFilter.end) return false; } return true;
    });
    view.sort((a,b)=>{
      let A=a[sortKey]??"", B=b[sortKey]??"";
      if(sortKey==="ë‚ ì§œ"){ const da=formatDate(A), db=formatDate(B); return sortAsc ? da.localeCompare(db) : db.localeCompare(da); }
      return sortAsc ? String(A).localeCompare(String(B),"ko",{numeric:true}) : String(B).localeCompare(String(A),"ko",{numeric:true});
    });
    return view;
  }

  function renderSchedule(){
    const view = getScheduleView(); const totalPages = Math.ceil(view.length/schedulePageSize)||1; if(schedulePage > totalPages) schedulePage=1;
    const start = (schedulePage-1)*schedulePageSize; const end = start + schedulePageSize;
    const tb = document.querySelector("#scheduleTable tbody"); tb.innerHTML = "";
    view.slice(start,end).forEach(r => {
      const tr = document.createElement("tr");
      FIELDS.forEach(k => {
        const td = document.createElement("td"); let val = (k==="ë‚ ì§œ" ? formatDate(r[k]) : r[k]);
        if(k==="ë‚ ì§œ" && val===TODAY_DATE_STR) { td.classList.add("text-red"); td.textContent = val; } 
        else if (k === "ì„¤ë¹„ID" && val) { td.innerHTML = `<span class="link-text" onclick="goToEquipmentSpec('${val}')">ğŸ”— ${val}</span>`; }
        else if (k === "ë°œì£¼ë²ˆí˜¸" && val) { td.innerHTML = `<span class="link-text" onclick="searchOrderByPO('${val}')">${val}</span>`; } 
        else { td.textContent = val; }
        tr.appendChild(td);
      });
      
      const isRegistered = isPreworkRegistered(r);
      const btnClass = isRegistered ? "btn-prework registered" : "btn-prework";

      tr.innerHTML += `<td>
          <button onclick='transferToPrework(${JSON.stringify(r)})' class="${btnClass} admin-only" style="padding:4px 8px;">ğŸ“ ì„ ì‘ì—…</button>
          <button onclick="openScheduleModal(${r.row})" class="admin-only">âœï¸</button> 
          <button onclick="deleteRecord(${r.row})" class="btn-danger admin-only">ğŸ—‘ï¸</button>
        </td>`;
      tb.appendChild(tr);
    });
    renderPaginator("pagination", totalPages, (p)=>{schedulePage=p;renderSchedule();}, schedulePage);
  }

  /* íŒì—… ì—†ì´ ì¦‰ì‹œ ë“±ë¡ & ë²„íŠ¼ ìƒíƒœ ê°±ì‹  */
  async function transferToPrework(data) {
      try {
          const payload = {
              action: "prework_add",
              date: formatDate(data["ë‚ ì§œ"]),
              team: data["ìƒì‚°íŒ€"],
              manager: data["ë‹´ë‹¹ì"],
              work: data["ì‘ì—…ë‚´ìš©"]
          };
          
          const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
          const result = await res.json();
          
          if(result.status === "success") {
              await loadPrework(); 
              if(currentView === 'calendar') {
                  renderCalendar();
                  updateDetailPanel(selectedDate);
              } else {
                  renderSchedule();
              }
          } else {
              alert("ì˜¤ë¥˜: " + result.message);
          }
      } catch (e) {
          alert("í†µì‹  ì˜¤ë¥˜: " + e.toString());
      }
  }

  function searchOrderByPO(po){ if(!po) return; switchTab('order'); document.getElementById('odSearch').value = po; document.getElementById('odSearch').dispatchEvent(new Event('input')); }
  function openScheduleModal(row){
      currentSchRow = row; const rec = records.find(r => r.row === row); if(!rec) return;
      document.getElementById('m_schDate').value = formatDate(rec["ë‚ ì§œ"]); document.getElementById('m_schTeam').value = rec["ìƒì‚°íŒ€"];
      document.getElementById('m_schEqId').value = rec["ì„¤ë¹„ID"];
      document.getElementById('m_schWork').value = rec["ì‘ì—…ë‚´ìš©"]; document.getElementById('m_schManager').value = rec["ë‹´ë‹¹ì"];
      document.getElementById('m_schOrderNo').value = rec["ë°œì£¼ë²ˆí˜¸"]; document.getElementById('m_schMat').value = rec["í•„ìˆ˜ìì¬"];
      document.getElementById('m_schPermit').value = rec["í—ˆê°€ë²ˆí˜¸"]; document.getElementById('m_schNote').value = rec["ë¹„ê³ "];
      openModal('scheduleModal');
  }
  async function saveScheduleFromModal(){
      const date=document.getElementById('m_schDate').value, team=document.getElementById('m_schTeam').value;
      const eqId=document.getElementById('m_schEqId').value;
      const work=document.getElementById('m_schWork').value, manager=document.getElementById('m_schManager').value;
      const orderNo=document.getElementById('m_schOrderNo').value;
      const mat=document.getElementById('m_schMat').value, permit=document.getElementById('m_schPermit').value, note=document.getElementById('m_schNote').value;
      await fetch(API_URL, {method:"POST", body:JSON.stringify({
          action:"update", row: currentSchRow, "ë‚ ì§œ": date, "ìƒì‚°íŒ€": team, "ì„¤ë¹„ID": eqId,
          "ì‘ì—…ë‚´ìš©": work, "ë‹´ë‹¹ì": manager, "ë°œì£¼ë²ˆí˜¸": orderNo, "í•„ìˆ˜ìì¬": mat, "í—ˆê°€ë²ˆí˜¸": permit, "ë¹„ê³ ": note
      })});
      closeModal('scheduleModal'); loadSchedule();
  }
  document.getElementById("scheduleForm").addEventListener("submit", async e => {
    e.preventDefault(); const fd = new FormData(e.target); const payload = {action:"add"}; FIELDS.forEach(k => payload[k] = fd.get(k)||"");
    await fetch(API_URL, {method:"POST", body:JSON.stringify(payload)}); e.target.reset(); loadSchedule();
  });
  async function deleteRecord(row){ if(confirm("ì‚­ì œ?")) { await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"delete", row})}); loadSchedule(); } }
  document.getElementById("searchBox").addEventListener("input",e=>{searchQuery=e.target.value; schedulePage=1; renderSchedule();});
  document.getElementById("filterBtn").addEventListener("click",()=>{dateFilter.start=document.getElementById("startDate").value; dateFilter.end=document.getElementById("endDate").value; schedulePage=1; renderSchedule();});
  document.getElementById("clearFilterBtn").addEventListener("click",()=>{dateFilter.start=null; dateFilter.end=null; document.getElementById("startDate").value=""; document.getElementById("endDate").value=""; schedulePage=1; renderSchedule();});
  document.getElementById("summaryBtn").addEventListener("click", () => {
    const container = document.getElementById("chartContainer"); if(container.style.display === "block"){ container.style.display="none"; return; }
    container.style.display = "block"; const view = getScheduleView(); const byMonth = {};
    view.forEach(r => { const d = formatDate(r["ë‚ ì§œ"]); if(d) byMonth[d.slice(0,7)] = (byMonth[d.slice(0,7)]||0) + 1; });
    const labels = Object.keys(byMonth).sort(); const data = labels.map(k => byMonth[k]);
    const ctx = document.getElementById('scheduleChart').getContext('2d'); if(scheduleChartInstance) scheduleChartInstance.destroy();
    scheduleChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'ì‘ì—… ê±´ìˆ˜', data, backgroundColor: 'rgba(74, 144, 226, 0.6)' }] }, options: { maintainAspectRatio:false, scales:{y:{beginAtZero:true}} } });
  });

  /* ================= 2. ì ê²€ì¼ì§€ (Checklist - Card View) ================= */
  let clPage=1, pageSizeCl=10, clRowMap=new Map();
  async function loadChecklist(){ try { const res = await fetch(API_URL+"?action=checklist_get"); const rows = await res.json(); if(!rows || rows.length === 0) return; clRowMap.clear(); const all = rows.slice(1).map((r,i)=>({row:i+2, cells:r})); all.forEach(it=>clRowMap.set(it.row, it.cells)); renderChecklistCards(); } catch(e) { console.error(e); } }
  function renderChecklistCards(){
      const kw = (document.getElementById('clSearch').value||"").toLowerCase();
      const sortKey = document.getElementById('clSortSel').value; 
      const all = Array.from(clRowMap.entries()).map(([k,v]) => ({row:k, cells:v}));
      const filtered = all.filter(it => (it.cells[2]||"").toLowerCase().includes(kw) || (it.cells[4]||"").toLowerCase().includes(kw));
      filtered.sort((a,b) => { let va, vb; if (sortKey === "ë‚ ì§œ") { return new Date(b.cells[0]) - new Date(a.cells[0]); } else if (sortKey === "ìƒì‚°íŒ€") { va = a.cells[1] || ""; vb = b.cells[1] || ""; return va.localeCompare(vb); } else if (sortKey === "ì„¤ë¹„ID") { va = a.cells[2] || ""; vb = b.cells[2] || ""; return va.localeCompare(vb); } return 0; });
      const totalPages = Math.ceil(filtered.length/pageSizeCl)||1; if(clPage > totalPages) clPage = 1;
      const start = (clPage-1)*pageSizeCl, end = start+pageSizeCl;
      const container = document.getElementById("checklistContainer"); container.innerHTML = "";
      if(filtered.length === 0) { container.innerHTML = `<div style="text-align:center; padding:30px; color:#aaa;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; document.getElementById("clPagination").innerHTML = ""; return; }
      filtered.slice(start,end).forEach(it => {
          const r = it.cells; const isOrderChecked = normalizeBool(r[7]), isStockChecked = normalizeBool(r[8]);
          let eqHtml = r[2] ? `<span class="link-text" onclick="goToEquipmentSpec('${r[2]}')">ğŸ”— ${r[2]}</span>` : '-';
          const card = document.createElement("div"); card.className = "cl-item-card";
          card.innerHTML = `<div class="cl-header"><div class="cl-header-left"><span class="cl-team">${r[1]}</span><span class="cl-date">${formatDate(r[0])}</span></div><div class="cl-header-right" style="color:#aaa; font-size:0.9em;">ğŸ‘¤ ${r[3]}</div></div><div style="font-size:0.95em;"><span>ì„¤ë¹„: ${eqHtml}</span></div><div class="cl-content-box">${r[4]}</div><div class="cl-footer"><div class="cl-mat-row"><span class="cl-mat-label" style="color:var(--warning-color)">ğŸ›’ ì£¼ë¬¸í•„ìš”:</span><span>${r[5] || '-'}</span></div><div class="cl-mat-row"><span class="cl-mat-label" style="color:var(--success-color)">ğŸ“¦ ë³´ìœ ì¤‘:</span><span>${r[6] || '-'}</span></div><div style="display:flex; align-items:center; gap:8px; margin-top:8px;"><span class="status-badge ${isOrderChecked?'order-active':''}" onclick="toggleChecklistStatus(${it.row}, 'order', ${!isOrderChecked})">ìì¬ì£¼ë¬¸ìš”ì²­</span><span class="status-badge ${isStockChecked?'stock-active':''}" onclick="toggleChecklistStatus(${it.row}, 'stock', ${!isStockChecked})">ë³´ìœ ìì¬í™•ì¸</span><button onclick='openChecklistModal(${it.row})' class="admin-only" style="padding:4px 8px;">âœï¸</button><button onclick='deleteChecklist(${it.row})' class="btn-danger admin-only" style="padding:4px 8px;">ğŸ—‘ï¸</button></div></div>`;
          container.appendChild(card);
      }); renderPaginator("clPagination", totalPages, (p)=>{clPage=p; renderChecklistCards();}, clPage);
  }
  async function saveChecklist(){ 
      const date=document.getElementById('clDate').value, team=document.getElementById('clTeam').value; const eqId=document.getElementById('clEqId').value, manager=document.getElementById('clManager').value; const content=document.getElementById('clContent').value; const matOrder=document.getElementById('clMatOrder').value, matStock=document.getElementById('clMatStock').value; if(!date || !content) { alert("í•„ìˆ˜"); return; } 
      await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"checklist_add", date, team, eqId, manager, content, matOrder, matStock})}); [clEqId,clContent,clMatOrder,clMatStock].forEach(el=>el.value=""); loadChecklist(); 
  }
  async function deleteChecklist(row){ if(confirm("ì‚­ì œ?")){ await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"checklist_delete",row})}); loadChecklist(); } }
  async function toggleChecklistStatus(row, type, val){ const old = clRowMap.get(row); if(old){ if(type === 'order') old[7] = val ? "TRUE" : "FALSE"; else old[8] = val ? "TRUE" : "FALSE"; renderChecklistCards(); await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"checklist_toggle", row, type, value: (val?"TRUE":"FALSE")})}); } }
  function openChecklistModal(row){ currentClRow = row; const old = clRowMap.get(row); document.getElementById('m_clDate').value = formatDate(old[0]); document.getElementById('m_clTeam').value = old[1]; document.getElementById('m_clEqId').value = old[2]; document.getElementById('m_clManager').value = old[3]; document.getElementById('m_clContent').value = old[4]; document.getElementById('m_clMatOrder').value = old[5]; document.getElementById('m_clMatStock').value = old[6]; document.getElementById('m_clChkOrder').checked = normalizeBool(old[7]); document.getElementById('m_clChkStock').checked = normalizeBool(old[8]); openModal('checklistModal'); }
  async function saveChecklistFromModal(){ const date=document.getElementById('m_clDate').value, team=document.getElementById('m_clTeam').value; const eqId=document.getElementById('m_clEqId').value, manager=document.getElementById('m_clManager').value; const content=document.getElementById('m_clContent').value, matOrder=document.getElementById('m_clMatOrder').value, matStock=document.getElementById('m_clMatStock').value, chkOrder=document.getElementById('m_clChkOrder').checked?"TRUE":"FALSE", chkStock=document.getElementById('m_clChkStock').checked?"TRUE":"FALSE"; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"checklist_update", row: currentClRow, date, team, eqId, manager, content, matOrder, matStock, chkOrder, chkStock})}); closeModal('checklistModal'); loadChecklist(); }
  document.getElementById("clSearch").addEventListener("input", ()=>{clPage=1; renderChecklistCards();});
  document.getElementById("clSortSel").addEventListener("change", ()=>{ clPage=1; renderChecklistCards(); });

  /* ================= 3. ì„ ì‘ì—… ê´€ë¦¬ ================= */
  let pwPage=1, pageSizePw=10, pwRowMap=new Map();
  async function loadPrework(){ try { const res = await fetch(API_URL+"?action=prework_get"); const rows = await res.json(); if(!rows || rows.length === 0) return; pwRowMap.clear(); const all = rows.slice(1).map((r,i)=>({row:i+2, cells:r})); all.forEach(it=>pwRowMap.set(it.row, it.cells)); renderPreworkTable(); } catch(e) { console.error(e); } }
  function renderPreworkTable(){
      const kw = (document.getElementById('pwSearch').value||"").toLowerCase(); const sortKey = document.getElementById('pwSortSel').value; const all = Array.from(pwRowMap.entries()).map(([k,v]) => ({row:k, cells:v})); const filtered = all.filter(it => (it.cells[3]||"").toLowerCase().includes(kw)); 
      filtered.sort((a,b) => { let va, vb; if (sortKey === "ë‚ ì§œ") { return new Date(b.cells[0]) - new Date(a.cells[0]); } else if (sortKey === "ìƒì‚°íŒ€") { va = a.cells[1] || ""; vb = b.cells[1] || ""; return va.localeCompare(vb); } else if (sortKey === "ì‘ì—…ë‚´ìš©") { va = a.cells[3] || ""; vb = b.cells[3] || ""; return va.localeCompare(vb); } return 0; });
      const totalPages = Math.ceil(filtered.length/pageSizePw)||1; if(pwPage > totalPages) pwPage = 1;
      const start = (pwPage-1)*pageSizePw, end = start+pageSizePw; const tb = document.querySelector("#pwTable tbody"); tb.innerHTML = "";
      filtered.slice(start,end).forEach(it => { const r = it.cells; const isChk1 = normalizeBool(r[4]), isChk2 = normalizeBool(r[5]), isChk3 = normalizeBool(r[6]), isChk4 = normalizeBool(r[7]); const tr = document.createElement("tr");
          tr.innerHTML = `<td>${formatDate(r[0])}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td style="text-align:center;"><span class="status-badge ${isChk1?'active-1':''}" onclick="togglePreworkStatus(${it.row}, 'chk1', ${!isChk1})">ì‘ì—…ì™„ë£Œ</span><span class="status-badge ${isChk2?'active-2':''}" onclick="togglePreworkStatus(${it.row}, 'chk2', ${!isChk2})">ë‚´ìš©ì „ë‹¬</span><span class="status-badge ${isChk3?'active-3':''}" onclick="togglePreworkStatus(${it.row}, 'chk3', ${!isChk3})">ì…ì°°ì™„ë£Œ</span><span class="status-badge ${isChk4?'active-4':''}" onclick="togglePreworkStatus(${it.row}, 'chk4', ${!isChk4})">ë°œì£¼ì™„ë£Œ</span></td><td><button onclick='openPreworkModal(${it.row})' class="admin-only">âœï¸</button> <button onclick='deletePrework(${it.row})' class="btn-danger admin-only">ğŸ—‘ï¸</button></td>`; tb.appendChild(tr);
      }); renderPaginator("pwPagination", totalPages, (p)=>{pwPage=p; renderPreworkTable();}, pwPage);
  }
  async function savePrework(){ const date=document.getElementById('pwDate').value, team=document.getElementById('pwTeam').value; const manager=document.getElementById('pwManager').value, work=document.getElementById('pwWork').value; if(!date || !work) { alert("í•„ìˆ˜"); return; } await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"prework_add", date, team, manager, work})}); [pwTeam,pwManager,pwWork].forEach(el=>el.value=""); loadPrework(); }
  async function deletePrework(row){ if(confirm("ì‚­ì œ?")){ await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"prework_delete",row})}); loadPrework(); } }
  async function togglePreworkStatus(row, type, val){ const old = pwRowMap.get(row); if(old){ const idxMap = {'chk1':4, 'chk2':5, 'chk3':6, 'chk4':7}; old[idxMap[type]] = val ? "TRUE" : "FALSE"; renderPreworkTable(); await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"prework_toggle", row, type, value: (val?"TRUE":"FALSE")})}); } }
  function openPreworkModal(row){ currentPwRow = row; const old = pwRowMap.get(row); document.getElementById('m_pwDate').value = formatDate(old[0]); document.getElementById('m_pwTeam').value = old[1]; document.getElementById('m_pwManager').value = old[2]; document.getElementById('m_pwWork').value = old[3]; document.getElementById('m_pwChk1').checked = normalizeBool(old[4]); document.getElementById('m_pwChk2').checked = normalizeBool(old[5]); document.getElementById('m_pwChk3').checked = normalizeBool(old[6]); document.getElementById('m_pwChk4').checked = normalizeBool(old[7]); openModal('preworkModal'); }
  async function savePreworkFromModal(){ const date=document.getElementById('m_pwDate').value, team=document.getElementById('m_pwTeam').value; const manager=document.getElementById('m_pwManager').value, work=document.getElementById('m_pwWork').value, chk1=document.getElementById('m_pwChk1').checked?"TRUE":"FALSE", chk2=document.getElementById('m_pwChk2').checked?"TRUE":"FALSE", chk3=document.getElementById('m_pwChk3').checked?"TRUE":"FALSE", chk4=document.getElementById('m_pwChk4').checked?"TRUE":"FALSE"; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"prework_update", row: currentPwRow, date, team, manager, work, chk1, chk2, chk3, chk4})}); closeModal('preworkModal'); loadPrework(); }
  document.getElementById("pwSearch").addEventListener("input", ()=>{pwPage=1; renderPreworkTable();});
  document.getElementById("pwSortSel").addEventListener("change", ()=>{ pwPage=1; renderPreworkTable(); });

  /* ================= 4. ë‚©í’ˆê´€ë¦¬ ================= */
  let dlPage=1, pageSizeDl=10, dlRowMap=new Map();
  async function loadDelivery(){ try { const res = await fetch(API_URL+"?action=delivery_get"); const rows = await res.json(); if(!rows || rows.length === 0) return; dlRowMap.clear(); const all = rows.slice(1).map((r,i)=>({row:i+2, cells:r})); all.forEach(it=>dlRowMap.set(it.row, it.cells)); renderDeliveryTable(); } catch(e) { console.error(e); } }
  function renderDeliveryTable(){
      const kw = (document.getElementById('dlSearch').value||"").toLowerCase(); const sortKey = document.getElementById('dlSortSel').value; const all = Array.from(dlRowMap.entries()).map(([k,v]) => ({row:k, cells:v})); const filtered = all.filter(it => (it.cells[4]||"").toLowerCase().includes(kw) || (it.cells[5]||"").toLowerCase().includes(kw));
      filtered.sort((a,b) => { let va, vb; if (sortKey === "ë‚ ì§œ") { return new Date(b.cells[0]) - new Date(a.cells[0]); } else if (sortKey === "ìƒì‚°íŒ€") { va = a.cells[2] || ""; vb = b.cells[2] || ""; return va.localeCompare(vb); } else if (sortKey === "ë‚©í’ˆë‚´ìš©") { va = a.cells[5] || ""; vb = b.cells[5] || ""; return va.localeCompare(vb); } return 0; });
      const totalPages = Math.ceil(filtered.length/pageSizeDl)||1; if(dlPage > totalPages) dlPage = 1;
      const start = (dlPage-1)*pageSizeDl, end = start+pageSizeDl; const tb = document.querySelector("#dlTable tbody"); tb.innerHTML = "";
      filtered.slice(start,end).forEach(it => { const r = it.cells; const isChk1 = normalizeBool(r[6]), isChk2 = normalizeBool(r[7]), isChk3 = normalizeBool(r[8]), isChk4 = normalizeBool(r[9]); const tr = document.createElement("tr"); tr.innerHTML = `<td>${formatDate(r[0])}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td><td>${r[5]}</td><td style="text-align:center;"><span class="status-badge ${isChk1?'active-1':''}" onclick="toggleDeliveryStatus(${it.row}, 'chk1', ${!isChk1})">ë°œì£¼í™•ì¸</span><span class="status-badge ${isChk2?'active-2':''}" onclick="toggleDeliveryStatus(${it.row}, 'chk2', ${!isChk2})">ì£¼ë¬¸ì™„ë£Œ</span><span class="status-badge ${isChk3?'active-3':''}" onclick="toggleDeliveryStatus(${it.row}, 'chk3', ${!isChk3})">ì…ê³ ì™„ë£Œ</span><span class="status-badge ${isChk4?'active-4':''}" onclick="toggleDeliveryStatus(${it.row}, 'chk4', ${!isChk4})">ë‚©í’ˆì™„ë£Œ</span></td><td><button onclick='openDeliveryModal(${it.row})' class="admin-only">âœï¸</button> <button onclick='deleteDelivery(${it.row})' class="btn-danger admin-only">ğŸ—‘ï¸</button></td>`; tb.appendChild(tr); }); renderPaginator("dlPagination", totalPages, (p)=>{dlPage=p; renderDeliveryTable();}, dlPage);
  }
  async function saveDelivery(){ const date=document.getElementById('dlDate').value, orderNo=document.getElementById('dlOrderNo').value, team=document.getElementById('dlTeam').value, manager=document.getElementById('dlManager').value, project=document.getElementById('dlProject').value, content=document.getElementById('dlContent').value; if(!date || !content) { alert("í•„ìˆ˜"); return; } await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"delivery_add", date, orderNo, team, manager, project, content})}); [dlOrderNo,dlTeam,dlManager,dlProject,dlContent].forEach(el=>el.value=""); loadDelivery(); }
  async function deleteDelivery(row){ if(confirm("ì‚­ì œ?")){ await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"delivery_delete",row})}); loadDelivery(); } }
  async function toggleDeliveryStatus(row, type, val){ const old = dlRowMap.get(row); if(old){ const idxMap = {'chk1':6, 'chk2':7, 'chk3':8, 'chk4':9}; old[idxMap[type]] = val ? "TRUE" : "FALSE"; renderDeliveryTable(); await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"delivery_toggle", row, type, value: (val?"TRUE":"FALSE")})}); } }
  function openDeliveryModal(row){ currentDlRow = row; const old = dlRowMap.get(row); document.getElementById('m_dlDate').value = formatDate(old[0]); document.getElementById('m_dlOrderNo').value = old[1]; document.getElementById('m_dlTeam').value = old[2]; document.getElementById('m_dlManager').value = old[3]; document.getElementById('m_dlProject').value = old[4]; document.getElementById('m_dlContent').value = old[5]; document.getElementById('m_dlChk1').checked = normalizeBool(old[6]); document.getElementById('m_dlChk2').checked = normalizeBool(old[7]); document.getElementById('m_dlChk3').checked = normalizeBool(old[8]); document.getElementById('m_dlChk4').checked = normalizeBool(old[9]); openModal('deliveryModal'); }
  async function saveDeliveryFromModal(){ const date=document.getElementById('m_dlDate').value, orderNo=document.getElementById('m_dlOrderNo').value, team=document.getElementById('m_dlTeam').value, manager=document.getElementById('m_dlManager').value, project=document.getElementById('m_dlProject').value, content=document.getElementById('m_dlContent').value, chk1=document.getElementById('m_dlChk1').checked?"TRUE":"FALSE", chk2=document.getElementById('m_dlChk2').checked?"TRUE":"FALSE", chk3=document.getElementById('m_dlChk3').checked?"TRUE":"FALSE", chk4=document.getElementById('m_dlChk4').checked?"TRUE":"FALSE"; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"delivery_update", row: currentDlRow, date, orderNo, team, manager, project, content, chk1, chk2, chk3, chk4})}); closeModal('deliveryModal'); loadDelivery(); }

  /* ================= 5. ë°œì£¼ì •ë³´ ================= */
  let odPage=1, pageSizeOrder=10, odRowMap=new Map(), odSortAsc=false;
  async function fetchOrderData() { try { const res = await fetch(API_URL+"?action=order_get"); const rows = await res.json(); odRowMap.clear(); const all = rows.slice(1).map((r,i)=>({row:i+2, cells:r})); all.forEach(it=>odRowMap.set(it.row, it.cells)); loadOrder(); } catch(e) { console.error(e); } }
  function loadOrder() { 
      const kw = (document.getElementById('odSearch').value||"").toLowerCase(); const all = Array.from(odRowMap.entries()).map(([k,v]) => ({row:k, cells:v})); const filtered = all.filter(it => it.cells.join(" ").toLowerCase().includes(kw)); 
      filtered.sort((a,b) => odSortAsc ? a.row-b.row : b.row-a.row); 
      const totalPages = Math.ceil(filtered.length/pageSizeOrder)||1; if(odPage > totalPages) odPage = 1; const start = (odPage-1)*pageSizeOrder, end = start+pageSizeOrder; const container = document.getElementById("orderListContainer"); container.innerHTML = "";
      filtered.slice(start,end).forEach(it => { 
          const r = it.cells; let isPermit = normalizeBool(r[19]), isDone = normalizeBool(r[20]); let permitClass = isPermit ? "status-badge permit-active" : "status-badge"; let doneClass = isDone ? "status-badge done-active" : "status-badge";
          const permitHtml = r[21] ? `<span class="od-link" onclick='transferToScheduleFromOrder(${it.row})'>${r[21]}</span>` : '<span style="color:#777">ì—†ìŒ</span>';
          const card = document.createElement("div"); card.className = "od-item-card";
          card.innerHTML = `<div class="od-header"><span class="od-tag">ì…ì°°: ${r[0]}</span><span class="od-tag">ì˜ë¢°: ${r[1]}</span><span class="od-tag">PO: ${r[2]}</span><span class="od-title">${r[5]}</span></div><div class="od-body"><div class="od-block"><span class="od-label" style="color:#4A90E2">ğŸ› ï¸ ì‘ì—…:</span><span class="od-value">${r[6]}</span></div><div class="od-block"><span class="od-label" style="color:#ff9f43">ğŸ§± ìì¬:</span><span class="od-value">${r[7] || '-'}</span></div><div class="od-block"><span class="od-label" style="color:#00e676">ğŸ›¡ï¸ í—ˆê°€:</span><span class="od-value">${permitHtml}</span></div></div><div class="od-footer"><div class="od-people">ğŸ‘¤ ì˜ë¢°: ${r[3]} / êµ¬ë§¤: ${r[4]}</div><div class="od-actions"><span class="${permitClass} admin-only" onclick="toggleOrderStatus(${it.row}, 'permit', ${!isPermit})">í—ˆê°€ë°œí–‰</span><span class="${doneClass} admin-only" onclick="toggleOrderStatus(${it.row}, 'done', ${!isDone})">ì‘ì—…ì™„ë£Œ</span><button onclick='openOrderModal(${it.row})' class="admin-only">âœï¸</button><button onclick='deleteOrder(${it.row})' class="btn-danger admin-only">ğŸ—‘ï¸</button></div></div>`;
          container.appendChild(card);
      }); renderPaginator("odPagination", totalPages, (p)=>{odPage=p; loadOrder();}, odPage); 
  }
  function transferToScheduleFromOrder(row) { 
      const data = odRowMap.get(row); if(!data) return; switchTab('schedule'); 
      ['n_schTeam','n_schWork','n_schManager','n_schOrderNo','n_schMat','n_schPermit','n_schNote','n_schEqId'].forEach(id => document.getElementById(id).value = "");
      document.getElementById('n_schDate').value = TODAY_DATE_STR; document.getElementById('n_schOrderNo').value = data[2]; document.getElementById('n_schMat').value = data[7]; document.getElementById('n_schPermit').value = data[21]; openModal('addScheduleModal'); 
  }
  async function toggleOrderStatus(row, type, newValue) { const old = odRowMap.get(row); if(old) { const strVal = newValue ? "TRUE" : "FALSE"; if(type === 'permit') old[19] = strVal; else old[20] = strVal; loadOrder(); await fetch(API_URL, {method: "POST", body: JSON.stringify({action: "order_toggle", row, type, value: strVal})}); } }
  function openOrderModal(row){ currentOdRow = row; const old = odRowMap.get(row) || Array(22).fill(""); document.getElementById('m_odBid').value = old[0]; document.getElementById('m_odReq').value = old[1]; document.getElementById('m_odPo').value = old[2]; document.getElementById('m_odRequester').value = old[3]; document.getElementById('m_odBuyer').value = old[4]; document.getElementById('m_odProject').value = old[5]; document.getElementById('m_odPermit').value = old[6]; document.getElementById('m_odMat').value = old[7]; document.getElementById('m_odPermitNo').value = old[21]; document.getElementById('m_odPermitCheck').checked = normalizeBool(old[19]); document.getElementById('m_odDoneCheck').checked = normalizeBool(old[20]); openModal('orderModal'); }
  async function saveOrderFromModal(){ const bid=document.getElementById('m_odBid').value, req=document.getElementById('m_odReq').value, po=document.getElementById('m_odPo').value, requester=document.getElementById('m_odRequester').value, buyer=document.getElementById('m_odBuyer').value, project=document.getElementById('m_odProject').value, permit=document.getElementById('m_odPermit').value, mat=document.getElementById('m_odMat').value, permitNo=document.getElementById('m_odPermitNo').value, permitYN = document.getElementById('m_odPermitCheck').checked ? "TRUE" : "FALSE", doneYN = document.getElementById('m_odDoneCheck').checked ? "TRUE" : "FALSE"; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"order_update", row: currentOdRow, bid, req, po, requester, buyer, project, permit, mat, permitNo, permitYN, doneYN})}); closeModal('orderModal'); fetchOrderData(); }
  async function saveOrder(){ const bid=document.getElementById('odBid').value, req=document.getElementById('odReq').value, po=document.getElementById('odPo').value, requester=document.getElementById('odRequester').value, buyer=document.getElementById('odBuyer').value, project=document.getElementById('odProject').value, permit=document.getElementById('odPermit').value, mat=document.getElementById('odMat').value, permitNo=document.getElementById('odPermitNo').value; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"order_add", bid, req, po, requester, buyer, project, permit, mat, permitNo, permitYN: "FALSE", doneYN: "FALSE"})}); [odBid,odReq,odPo,odRequester,odBuyer,odProject,odPermit,odMat,odPermitNo].forEach(el=>el.value=""); fetchOrderData(); }
  async function deleteOrder(row){ if(confirm("ì‚­ì œ?")){ await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"order_delete",row})}); fetchOrderData(); } }
  document.getElementById("odSearch").addEventListener("input",()=>{odPage=1;loadOrder();}); document.getElementById("odNewestBtn").addEventListener("click",()=>{ odSortAsc=false; odPage=1; loadOrder(); }); document.getElementById("odOldestBtn").addEventListener("click",()=>{ odSortAsc=true; odPage=1; loadOrder(); });

  /* ================= ì „í™”ë²ˆí˜¸ë¶€ & ë²„ì¼“ & ì„¤ë¹„ ================= */
  let pbPage=1, pageSizePhone=10, pbRowMap=new Map(), pbAllData=[];
  async function loadPhonebook(){ try{ const res=await fetch(API_URL+"?action=phone_get"); const rows=await res.json(); if(!Array.isArray(rows)) return; pbRowMap.clear(); pbAllData=rows.slice(1).map((r,i)=>({row:i+2,cells:r})); pbAllData.forEach(it=>pbRowMap.set(it.row,it.cells)); renderPhonebookTable(); }catch(e){console.error(e);} }
  function renderPhonebookTable(){ const kw=(document.getElementById('pbSearch').value||"").toLowerCase(); const filtered=pbAllData.filter(it=>it.cells.join(" ").toLowerCase().includes(kw)); const totalPages=Math.ceil(filtered.length/pageSizePhone)||1; if(pbPage>totalPages) pbPage=1; const start=(pbPage-1)*pageSizePhone, end=start+pageSizePhone; const tb=document.querySelector("#pbTable tbody"); tb.innerHTML=""; filtered.slice(start,end).forEach(it=>{ const r=it.cells; const tr=document.createElement("tr"); tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td><button onclick='openPhoneModal(${it.row})' class="admin-only">âœï¸</button> <button onclick='deletePhone(${it.row})' class="btn-danger admin-only">ğŸ—‘ï¸</button></td>`; tb.appendChild(tr); }); renderPaginator("pbPagination",totalPages,(p)=>{pbPage=p;renderPhonebookTable();},pbPage); }
  function openPhoneModal(row){ currentPbRow=row; const old=pbRowMap.get(row)||["","","",""]; document.getElementById('m_pbDept').value=old[0]; document.getElementById('m_pbPos').value=old[1]; document.getElementById('m_pbName').value=old[2]; document.getElementById('m_pbPhone').value=old[3]; openModal('phoneModal'); }
  async function savePhoneFromModal(){ const dept=document.getElementById('m_pbDept').value, pos=document.getElementById('m_pbPos').value, name=document.getElementById('m_pbName').value, phone=document.getElementById('m_pbPhone').value; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"phone_update",row:currentPbRow, dept,position:pos,name,phone})}); closeModal('phoneModal'); loadPhonebook(); }
  async function savePhonebook(){ const dept=document.getElementById('pbDept').value, pos=document.getElementById('pbPosition').value; const name=document.getElementById('pbName').value, phone=document.getElementById('pbPhone').value; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"phone_add",dept,position:pos,name,phone})}); ['pbDept','pbPosition','pbName','pbPhone'].forEach(id=>document.getElementById(id).value=""); loadPhonebook(); }
  async function deletePhone(row){ if(confirm("ì‚­ì œ?")){ await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"phone_delete",row})}); loadPhonebook(); } }
  document.getElementById("pbSearch").addEventListener("input",()=>{pbPage=1;renderPhonebookTable();});

  /* [NEW] ë²„ì¼“ì£¼ê¸° (Structured Dashboard) */
  let bkRowMap = new Map();
  let bkAllData = [];
  let bkSelectedTeam = "ì œë ¨1íŒ€"; 

  const TEAM_STRUCTURE = {
      "ì œë ¨1íŒ€": ["ì €ê´‘ì‚¬ ì„œìª½", "ì €ê´‘ì‚¬ ë™ìª½", "SF1 PIT", "SF1 COLD PIT"],
      "ì œë ¨2íŒ€": ["ì €ê´‘ì‚¬ ë‚¨ìª½", "ì €ê´‘ì‚¬ ë¶ìª½", "SF2 PIT", "SF2 COLD PIT"],
      "ì œë ¨3íŒ€": ["TSL1 PIT", "TSL2 PIT"],
      "OF2íŒ€": ["OF2 PIT", "OF4 PIT"],
      "ë™ìˆœí™˜ìì›íŒ€": ["ë™ìˆœí™˜ìì› PIT"]
  };

  async function loadBucket(){ 
      const res = await fetch(API_URL+"?action=bucket_get"); 
      const rows = await res.json(); 
      if(!rows || rows.length === 0) return;
      bkRowMap.clear(); 
      bkAllData = rows.slice(1).map((r,i)=>({row:i+2, cells:r})); 
      bkAllData.forEach(it=>bkRowMap.set(it.row,it.cells)); 
      
      renderBucketFilters();
      renderBucketCards(); 
  }

  function renderBucketFilters() {
      const container = document.getElementById("bkFilterContainer");
      container.innerHTML = "";
      Object.keys(TEAM_STRUCTURE).forEach(team => {
          const isActive = bkSelectedTeam === team ? 'active' : '';
          container.innerHTML += `<button class="bk-filter-btn ${isActive}" onclick="setBucketFilter('${team}')">${team}</button>`;
      });
  }

  function setBucketFilter(team) {
      bkSelectedTeam = team;
      renderBucketFilters(); 
      renderBucketCards();   
  }

  function renderBucketCards() {
      const container = document.getElementById("bkDashboard");
      container.innerHTML = "";

      const targetLocations = TEAM_STRUCTURE[bkSelectedTeam] || [];

      targetLocations.forEach(locName => {
          const matched = bkAllData.filter(it => (it.cells[0]||"").includes(locName));
          matched.sort((a,b) => new Date(b.cells[1]) - new Date(a.cells[1]));
          
          const latest = matched.length > 0 ? matched[0] : null;
          const latestDateStr = latest ? latest.cells[1] : "";
          const elapsed = latest ? getElapsedDays(latestDateStr) : 0;
          
          let elapsedClass = "bk-elapsed-val"; 
          if(elapsed > 180) elapsedClass += " danger"; 
          else if(elapsed > 90) elapsedClass += " warn";

          const card = document.createElement("div");
          card.className = "bk-card";
          
          let historyHtml = "";
          if(matched.length > 0) {
              historyHtml = matched.map(h => `
                  <div class="bk-history-item">
                      <span>${formatDate(h.cells[1])}</span>
                      <span style="color:#aaa;">${h.cells[2] || '-'}</span>
                      <button onclick='deleteBucket(${h.row})' class="btn-danger admin-only" style="padding:0 4px; font-size:0.7em;">x</button>
                  </div>
              `).join('');
          } else {
              historyHtml = "<div style='text-align:center; padding:10px; color:#666;'>ê¸°ë¡ ì—†ìŒ</div>";
          }

          card.innerHTML = `
              <div class="bk-header">
                  <div class="bk-dept">${locName}</div>
                  <div style="display:flex; gap:5px;">
                      <button onclick="openAddBucketModal('${locName}')" class="btn-primary admin-only" style="padding:2px 8px; font-size:0.8em;">+ ë“±ë¡</button>
                  </div>
              </div>
              <div class="bk-latest-date">ìµœê·¼ êµì²´: ${latest ? formatDate(latestDateStr) : "-"}</div>
              <div class="bk-elapsed-box">
                  <div class="bk-elapsed-label">êµì²´ í›„ ê²½ê³¼ ì‹œê°„</div>
                  <div class="${elapsedClass}">${latest ? elapsed + "ì¼" : "-"}</div>
              </div>
              <div class="bk-history-toggle" onclick="toggleHistory(this)">
                  â–¼ ì§€ë‚œ ê¸°ë¡ ë³´ê¸° (${matched.length}ê±´)
              </div>
              <div class="bk-history-list">
                  ${historyHtml}
              </div>
          `;
          container.appendChild(card);
      });
  }

  function getElapsedDays(dateStr) {
      const target = new Date(dateStr);
      const now = new Date();
      if(isNaN(target)) return 0;
      return Math.floor((now - target) / (1000 * 60 * 60 * 24));
  }

  function toggleHistory(el) {
      const list = el.nextElementSibling;
      if(list.style.display === "block") {
          list.style.display = "none";
          el.innerText = el.innerText.replace("â–²", "â–¼");
      } else {
          list.style.display = "block";
          el.innerText = el.innerText.replace("â–¼", "â–²");
      }
  }

  /* [NEW] ë²„ì¼“ ë“±ë¡ íŒì—… ê´€ë ¨ í•¨ìˆ˜ */
  function openAddBucketModal(deptName) {
      document.getElementById('n_bkDept').value = deptName;
      document.getElementById('addBucketTitle').innerText = `ğŸª£ ${deptName} êµì²´ ë“±ë¡`;
      document.getElementById('n_bkDate').value = getTodayStr(); // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸
      document.getElementById('n_bkNote').value = "";
      openModal('addBucketEntryModal');
  }

  async function submitBucketEntry() {
      const dept = document.getElementById('n_bkDept').value;
      const date = document.getElementById('n_bkDate').value;
      const note = document.getElementById('n_bkNote').value;
      
      if(!dept || !date) { alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

      await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"bucket_add", dept, date, note})});
      
      closeModal('addBucketEntryModal');
      loadBucket(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
  }

  // ì‚­ì œ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
  async function deleteBucket(row){ if(confirm("ì‚­ì œ?")){ await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"bucket_delete",row})}); loadBucket(); } }
  
  let esPage=1, pageSizeSpec=5, esRowMap=new Map(), esAllData = []; const defaultSpecs = ["í¬ë ˆì¸ ì¢…ë¥˜", "ì–‘ì •", "ì •ê²© ì†ë„", "ëª¨í„°", "ê°ì†ê¸°", "ë ˆì¼", "ì™€ì´ì–´ë¡œí”„"];
  async function loadEquipmentSpec(){ const res = await fetch(API_URL+"?action=spec_get"); const rows = await res.json(); esRowMap.clear(); esAllData = rows.slice(1).map((r,i)=>({row:i+2, cells:r})); esAllData.forEach(it=>esRowMap.set(it.row,it.cells)); initTeamFilter(); renderEquipmentTable(); }
  function initTeamFilter() { const teams = new Set(); esAllData.forEach(it => { if(it.cells[0]) teams.add(it.cells[0]); }); const teamSel = document.getElementById('filterTeam'); while(teamSel.options.length > 1) teamSel.remove(1); Array.from(teams).sort().forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.textContent = t; teamSel.appendChild(opt); }); }
  function updateLocationOptions() { const selectedTeam = document.getElementById('filterTeam').value, locSel = document.getElementById('filterLoc'); let sourceData = esAllData; if (selectedTeam) sourceData = esAllData.filter(it => it.cells[0] === selectedTeam); const locs = new Set(); sourceData.forEach(it => { if(it.cells[2]) locs.add(it.cells[2]); }); locSel.innerHTML = '<option value="">ğŸ“ ëª¨ë“  ìœ„ì¹˜ ë³´ê¸°</option>'; Array.from(locs).sort().forEach(l => { const opt = document.createElement('option'); opt.value = l; opt.textContent = l; locSel.appendChild(opt); }); }
  function renderEquipmentTable() { const teamFilter = document.getElementById('filterTeam').value, locFilter = document.getElementById('filterLoc').value, keyword = (document.getElementById('esSearch').value || "").toLowerCase(); let filtered = esAllData.filter(it => { const r = it.cells; if (teamFilter && r[0] !== teamFilter) return false; if (locFilter && r[2] !== locFilter) return false; if (keyword) { const hay = r.join(" ").toLowerCase(); if (!hay.includes(keyword)) return false; } return true; }); const totalPages = Math.ceil(filtered.length/pageSizeSpec)||1; if(esPage > totalPages) esPage=1; const start=(esPage-1)*pageSizeSpec, end=start+pageSizeSpec; const tb = document.querySelector("#esTable tbody"); tb.innerHTML=""; if(filtered.length === 0) { tb.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px;">ì¡°ê±´ì— ë§ëŠ” ì„¤ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`; document.getElementById("esPagination").innerHTML=""; return; } filtered.slice(start,end).forEach(it=>{ const r=it.cells, tr=document.createElement("tr"); let specDisplay = "ì—†ìŒ"; try { const parsed = JSON.parse(r[3]); if(Object.keys(parsed).length > 0) specDisplay = Object.entries(parsed).map(([k,v]) => `<div style="padding:4px 0; border-bottom:1px solid #333; display:flex; align-items:center;"><span style="color:#81D4FA; font-weight:600; min-width:80px; margin-right:8px;">${k}</span><span style="color:#ffffff;">${v}</span></div>`).join(""); } catch {} tr.innerHTML=`<td>${r[0]}</td><td style="font-weight:bold; color:var(--primary-color);">${r[1]}</td><td>${r[2]||'-'}</td><td style="font-size:0.9em; line-height:1.4;">${specDisplay}</td><td><button onclick='openSpecModal("edit", ${it.row})' class="admin-only">ğŸ“ ìƒì„¸/ìˆ˜ì •</button> <button onclick='deleteEquipmentSpec(${it.row})' class="btn-danger admin-only">ğŸ—‘ï¸</button></td>`; tb.appendChild(tr); }); renderPaginator("esPagination",totalPages,(p)=>{esPage=p;renderEquipmentTable();},esPage); }
  function resetEquipmentFilter() { document.getElementById('filterTeam').value = ""; document.getElementById('filterLoc').value = ""; updateLocationOptions(); document.getElementById('esSearch').value = ""; esPage = 1; renderEquipmentTable(); }
  document.getElementById('filterTeam').addEventListener('change', () => { updateLocationOptions(); esPage=1; renderEquipmentTable(); }); document.getElementById('filterLoc').addEventListener('change', () => { esPage=1; renderEquipmentTable(); }); document.getElementById("esSearch").addEventListener("input", () => { esPage=1; renderEquipmentTable(); });
  function openSpecModal(mode, row = null) { const tbody = document.querySelector("#modalSpecTable tbody"); tbody.innerHTML = ""; const inTeam = document.getElementById("m_esTeam_modal"), inEqId = document.getElementById("m_esEqId_modal"), inLoc = document.getElementById("m_esLocation_modal"); if (mode === 'new') { const topTeam = document.getElementById('esTeam').value, topEqId = document.getElementById('esEqId').value, topLoc = document.getElementById('esLocation').value; if(!topTeam || !topEqId) { alert("ìƒë‹¨ì˜ íŒ€ê³¼ ì„¤ë¹„IDë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } currentSpecRow = null; inTeam.value = topTeam; inEqId.value = topEqId; inLoc.value = topLoc; defaultSpecs.forEach(k => addModalRow(k, "")); } else { currentSpecRow = row; const data = esRowMap.get(row); inTeam.value = data[0]; inEqId.value = data[1]; inLoc.value = data[2]; try { const json = JSON.parse(data[3]); Object.entries(json).forEach(([k,v])=>addModalRow(k,v)); } catch { defaultSpecs.forEach(k => addModalRow(k, "")); } } openModal('specModal'); }
  function addModalRow(key="", value="") { const tbody = document.querySelector("#modalSpecTable tbody"); const tr = document.createElement("tr"); tr.innerHTML = `<td><input type="text" value="${key}" style="width:95%"></td><td><input type="text" value="${value}" style="width:95%"></td><td style="text-align:center;"><button onclick="this.closest('tr').remove()" class="btn-danger">x</button></td>`; tbody.appendChild(tr); }
  async function saveSpecFromModal() { const rows = document.querySelectorAll("#modalSpecTable tbody tr"); const newSpec = {}; rows.forEach(tr => { const inputs = tr.querySelectorAll("input"); if(inputs[0].value) newSpec[inputs[0].value] = inputs[1].value; }); const specStr = JSON.stringify(newSpec), newTeam = document.getElementById("m_esTeam_modal").value, newEqId = document.getElementById("m_esEqId_modal").value, newLoc = document.getElementById("m_esLocation_modal").value; if (currentSpecRow === null) { await fetch(API_URL, {method:"POST",body:JSON.stringify({action:"spec_add", team: newTeam, eqId: newEqId, location: newLoc, spec: specStr})}); document.getElementById('esTeam').value=""; document.getElementById('esEqId').value=""; document.getElementById('esLocation').value=""; } else { await fetch(API_URL, {method:"POST",body:JSON.stringify({action:"spec_update", row: currentSpecRow, team: newTeam, eqId: newEqId, location: newLoc, spec: specStr})}); } closeModal('specModal'); alert("ì €ì¥ë¨"); loadEquipmentSpec(); }
  async function deleteEquipmentSpec(row){ if(confirm("ì‚­ì œ?")) { await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"spec_delete",row})}); loadEquipmentSpec(); } }

  /* ì´ˆê¸°í™” */
  toggleScheduleView('calendar'); loadSchedule(true); loadPhonebook(); loadBucket(); fetchOrderData(); loadEquipmentSpec(); loadPrework(); loadDelivery(); 
  loadChecklist(); 
</script>
</body>
</html>

